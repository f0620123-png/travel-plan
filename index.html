<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0F766E" />
  <title>Travel Plan</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect rx='42' ry='42' width='180' height='180' fill='%230F766E'/%3E%3Cpath d='M53 111c-6-5-8-12-5-19 3-8 12-12 20-9l11 4 22-20c6-5 14-7 22-5l21 6c6 2 10 7 11 13 1 7-2 13-8 17l-29 18 7 14c2 5 0 11-5 13-4 2-9 1-12-3l-12-16-14 9c-4 3-10 2-13-2z' fill='white'/%3E%3Ccircle cx='132' cy='67' r='10' fill='white'/%3E%3C/svg%3E" />

  <style>
    :root{
      --md-sys-color-primary:#0F766E;
      --md-sys-color-on-primary:#FFFFFF;
      --md-sys-color-primary-container:#CFFAFE;
      --md-sys-color-on-primary-container:#042F2E;

      --md-sys-color-secondary:#2563EB;
      --md-sys-color-surface:#F7FAFA;
      --md-sys-color-surface-2:#FFFFFF;
      --md-sys-color-on-surface:#0B1220;
      --md-sys-color-on-surface-variant:#4B5563;
      --md-sys-color-outline:#D1D5DB;
      --md-sys-color-error:#B91C1C;

      --md-elev-1: 0 1px 2px rgba(0,0,0,.08), 0 1px 3px rgba(0,0,0,.06);
      --md-elev-2: 0 6px 14px rgba(0,0,0,.10), 0 2px 4px rgba(0,0,0,.08);

      --r-lg: 18px;
      --r-md: 14px;
      --r-sm: 12px;

      --pad: 14px;
      --gap: 12px;

      --font: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg, #0F766E 0%, #0F766E 160px, var(--md-sys-color-surface) 160px);
      color:var(--md-sys-color-on-surface);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit}

    /* App frame */
    .app{
      min-height:100%;
      padding-bottom: 86px; /* bottom nav */
    }

    /* Top App Bar */
    .topbar{
      position:sticky; top:0; z-index:20;
      padding: calc(env(safe-area-inset-top) + 10px) var(--pad) 10px;
      background:rgba(15,118,110,.98);
      backdrop-filter: blur(10px);
    }
    .topbar-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .iconbtn{
      width:42px; height:42px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(0,0,0,.15);
      color:white;
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .titlebox{
      flex:1;
      min-width:0;
      color:white;
    }
    .title{
      font-size:18px; font-weight:800; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .subtitle{
      margin-top:2px;
      font-size:12px;
      opacity:.9;
    }

    .seg-actions{
      display:flex; gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.12);
    }
    .seg-actions button{
      width:42px; height:42px;
      border-radius:999px;
      border:0;
      background:transparent;
      color:white;
      cursor:pointer;
    }
    .seg-actions button.active{
      background:white;
      color: var(--md-sys-color-on-surface);
      box-shadow: var(--md-elev-1);
    }
    .seg-actions .glyph{
      font-size:18px;
      font-weight:900;
      line-height:1;
    }

    /* Content */
    .content{
      padding: 12px var(--pad) 16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* Cards */
    .card{
      background: var(--md-sys-color-surface-2);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: var(--r-lg);
      box-shadow: var(--md-elev-1);
      overflow:hidden;
    }
    .card-hd{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .card-hd h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card-bd{ padding: 0 14px 14px; }

    /* Day chips */
    .daystrip{
      display:flex;
      gap:10px;
      overflow:auto;
      padding: 8px 2px 2px;
      scrollbar-width:none;
    }
    .daystrip::-webkit-scrollbar{display:none}
    .daychip{
      min-width:78px;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.28);
      background:rgba(0,0,0,.08);
      color:white;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .daychip .dnum{font-weight:900; font-size:16px}
    .daychip .date{font-size:12px; opacity:.9}
    .daychip.active{
      background:white;
      color: var(--md-sys-color-on-surface);
      border-color: rgba(0,0,0,.06);
      box-shadow: var(--md-elev-1);
    }

    /* Form controls */
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:8px}
    .label{
      font-size:12px;
      color: var(--md-sys-color-on-surface-variant);
    }
    .tf{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--md-sys-color-outline);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    .tf:focus{ border-color: rgba(15,118,110,.9); box-shadow: 0 0 0 3px rgba(15,118,110,.12); }
    .select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--md-sys-color-outline);
      background:#fff;
      font-size:14px;
    }

    .btn{
      border:0;
      padding: 12px 14px;
      border-radius: 999px;
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      font-weight:800;
      cursor:pointer;
      box-shadow: var(--md-elev-1);
      white-space:nowrap;
    }
    .btn.tonal{
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
    }
    .btn.outline{
      background:transparent;
      color: var(--md-sys-color-on-surface);
      border:1px solid var(--md-sys-color-outline);
      box-shadow:none;
    }
    .btn.danger{
      background: var(--md-sys-color-error);
      color:white;
    }

    /* Chips (category selector) */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--md-sys-color-outline);
      background:#fff;
      font-size:13px;
      font-weight:800;
      color: var(--md-sys-color-on-surface);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(15,118,110,.45);
      background: rgba(15,118,110,.10);
      color: #064E4A;
    }

    /* Itinerary items */
    .item{
      display:flex;
      gap:12px;
      padding: 12px;
      border-radius: var(--r-lg);
      border:1px solid rgba(0,0,0,.06);
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .timebox{
      width:78px;
      flex:0 0 78px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:8px;
    }
    .timeinput{
      width:78px;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid var(--md-sys-color-outline);
      font-weight:900;
      font-size:16px;
      outline:none;
    }
    .smallbtn{
      width:78px;
      padding:10px 0;
      border-radius:999px;
      border:1px solid var(--md-sys-color-outline);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }

    .meta{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .meta .topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .titleinput{
      flex:1;
      min-width:0;
      font-size:16px;
      font-weight:900;
      border:0;
      outline:none;
      padding: 6px 0;
    }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
      background: rgba(15,118,110,.10);
      color:#064E4A;
      white-space:nowrap;
    }
    .place{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      color: var(--md-sys-color-on-surface-variant);
      font-size:13px;
    }
    .place .pin{font-weight:900}
    .place .addr{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .item-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.08);
      background: #fff;
      font-weight:900;
      font-size:13px;
      color: var(--md-sys-color-on-surface);
      cursor:pointer;
      user-select:none;
    }
    .pill .hint{font-weight:800; color: var(--md-sys-color-on-surface-variant)}
    .pill select{
      border:0; outline:none; background:transparent; font-weight:900;
    }
    .pill input{
      width:60px;
      border:0; outline:none; background:transparent;
      font-weight:900;
    }
    .switch{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .switch input{ width:46px; height:26px; }

    .trash{
      margin-left:auto;
      border:0;
      background:transparent;
      color: var(--md-sys-color-on-surface-variant);
      font-weight:900;
      cursor:pointer;
    }

    /* Route card */
    .route{
      margin: 10px 0 0 0;
      padding: 12px;
      border-radius: var(--r-lg);
      border:1px dashed rgba(0,0,0,.18);
      background: rgba(15,118,110,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .route-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .route-modes{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modechip{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .modechip.active{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.35);
      color:#1E3A8A;
    }
    .route-bottom{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Flight card */
    .flight{
      background: linear-gradient(90deg, rgba(37,99,235,.18), rgba(15,118,110,.14));
      border: 1px solid rgba(0,0,0,.06);
    }
    .flight-inner{
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .flight-side{
      width:40%;
      min-width:0;
    }
    .flight-time{
      font-weight:1000;
      font-size:20px;
      letter-spacing:.2px;
    }
    .flight-label{
      font-size:12px;
      font-weight:900;
      color: var(--md-sys-color-on-surface-variant);
      margin-top:2px;
    }
    .flight-air{
      margin-top:6px;
      font-weight:1000;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .flight-mid{
      width:20%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .flight-mid .plane{ font-size:18px; font-weight:1000; }
    .flight-mid .no{ font-size:12px; font-weight:1000; opacity:.9;}
    .flight-mid .dur{
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      font-weight:1000;
      font-size:12px;
      text-align:center;
      min-width:92px;
    }
    .arrive-big{
      display:inline-block;
      margin-left:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(185,28,28,.12);
      color:#7F1D1D;
      font-weight:1000;
      font-size:12px;
      vertical-align:middle;
    }

    /* Bottom nav */
    .bottomnav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px var(--pad) calc(env(safe-area-inset-bottom) + 12px);
      background:rgba(247,250,250,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(0,0,0,.06);
      z-index:30;
    }
    .navrow{
      display:flex;
      gap:10px;
    }
    .navbtn{
      flex:1;
      padding: 12px 10px;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:1000;
    }
    .navbtn.active{
      background: rgba(15,118,110,.12);
      border-color: rgba(15,118,110,.22);
      color:#064E4A;
    }
    .navbtn .glyph{ font-weight:1200; }

    /* FAB */
    .fab{
      position:fixed;
      right: var(--pad);
      bottom: calc(env(safe-area-inset-bottom) + 90px);
      width:56px; height:56px;
      border-radius: 18px;
      border:0;
      background: var(--md-sys-color-primary);
      color:white;
      font-size:26px;
      font-weight:1000;
      box-shadow: var(--md-elev-2);
      cursor:pointer;
      z-index:40;
    }

    /* Snackbar */
    .snack{
      position:fixed;
      left: var(--pad);
      right: var(--pad);
      bottom: calc(env(safe-area-inset-bottom) + 160px);
      background: rgba(11,18,32,.92);
      color:white;
      padding: 12px 14px;
      border-radius: 16px;
      box-shadow: var(--md-elev-2);
      display:none;
      z-index:60;
      font-weight:900;
    }

    /* Dialog */
    .dlg-mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:80;
      padding: 16px;
      align-items:flex-end;
    }
    .dlg{
      width:100%;
      max-width: 680px;
      margin: 0 auto;
      background:#fff;
      border-radius: 24px;
      box-shadow: var(--md-elev-2);
      overflow:hidden;
      max-height: 86vh;
      display:flex;
      flex-direction:column;
    }
    .dlg-hd{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .dlg-hd .t{font-weight:1000}
    .dlg-bd{
      padding: 12px 14px 14px;
      overflow:auto;
    }
    .dlg-ft{
      padding: 12px 14px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(0,0,0,.06);
    }

    .muted{ color: var(--md-sys-color-on-surface-variant); }
    .hr{ height:1px; background:rgba(0,0,0,.06); margin: 12px 0; }

    /* Boot overlay to avoid "blank" */
    #boot{
      position:fixed; inset:0;
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      font-weight:1000;
      color:#0B1220;
    }
  </style>
</head>

<body>
  <div id="boot">è¼‰å…¥ä¸­â€¦</div>
  <div id="app" class="app" aria-label="Travel Plan App"></div>

  <div class="snack" id="snack"></div>

  <!-- Flights dialog -->
  <div class="dlg-mask" id="dlgMask">
    <div class="dlg" role="dialog" aria-modal="true">
      <div class="dlg-hd">
        <div class="t">èˆªç­è¨­å®šï¼ˆæœ€å¤š 2 æ®µ / å»å›ï¼‰</div>
        <button class="iconbtn" id="dlgClose" aria-label="Close">âœ•</button>
      </div>
      <div class="dlg-bd" id="dlgBody"></div>
      <div class="dlg-ft">
        <button class="btn outline" id="dlgCancel">å–æ¶ˆ</button>
        <button class="btn" id="dlgSave">å„²å­˜</button>
      </div>
    </div>
  </div>

<script>
/* ---------------------------
   Minimal error overlay (no console needed)
---------------------------- */
(function(){
  const boot = document.getElementById('boot');
  window.addEventListener('error', (e)=>{
    boot.style.display='flex';
    boot.style.padding='16px';
    boot.style.whiteSpace='pre-wrap';
    boot.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼š\\n' + (e.message || 'Unknown') + '\\n\\nä½ å¯ä»¥æŠŠé€™æ®µæˆªåœ–å‚³çµ¦æˆ‘ï¼Œæˆ‘å°±èƒ½ç²¾æº–ä¿®ã€‚';
  });
  window.addEventListener('unhandledrejection', (e)=>{
    boot.style.display='flex';
    boot.style.padding='16px';
    boot.style.whiteSpace='pre-wrap';
    boot.textContent = 'Promise éŒ¯èª¤ï¼š\\n' + (e.reason?.message || String(e.reason)) + '\\n\\nä½ å¯ä»¥æŠŠé€™æ®µæˆªåœ–å‚³çµ¦æˆ‘ã€‚';
  });
})();

/* ---------------------------
   State + Storage
---------------------------- */
const LS_KEY = 'travel_plan_state_v3_md';

const CATEGORIES = ['ç¾é£Ÿ','è³¼ç‰©','ä½å®¿','éŠæ¨‚','äº¤é€š','æ™¯é»'];

const DEFAULT_STATE = {
  trip: {
    name: 'çš‡åé®',
    startDate: '2026-02-26',
    endDate: '2026-03-06',
  },
  view: 'plan', // plan | translate | money
  selectedDay: 0,

  flights: {
    outbound: [
      { flightNo:'', from:'TPE', to:'', departDate:'', departTime:'', arriveTime:'', arriveNextDay:false },
      { flightNo:'', from:'', to:'', departDate:'', departTime:'', arriveTime:'', arriveNextDay:false },
    ],
    inbound: [
      { flightNo:'', from:'', to:'TPE', departDate:'', departTime:'', arriveTime:'', arriveNextDay:false },
      { flightNo:'', from:'', to:'', departDate:'', departTime:'', arriveTime:'', arriveNextDay:false },
    ],
  },

  days: [],

  routeModeDefault: 'walk', // walk | drive | transit

  translate: {
    sl: 'zh-TW',
    tl: 'th',
    text: '',
  },

  money: {
    currency: 'NZD',
    twd: 'TWD',
    exchangeRate: 19.2,
    autoRate: true,
    lastRateDate: '',
    expenses: [] // {id, dayIndex, title, amount}
  }
};

function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(DEFAULT_STATE);
    const s = JSON.parse(raw);
    return mergeDeep(structuredClone(DEFAULT_STATE), s);
  }catch{
    return structuredClone(DEFAULT_STATE);
  }
}

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

function mergeDeep(target, src){
  for(const k in src){
    if(src[k] && typeof src[k]==='object' && !Array.isArray(src[k])){
      target[k] = mergeDeep(target[k] || {}, src[k]);
    }else{
      target[k] = src[k];
    }
  }
  return target;
}

let state = loadState();

/* ---------------------------
   Date helpers
---------------------------- */
function parseDate(s){ // YYYY-MM-DD
  const [y,m,d] = s.split('-').map(Number);
  return new Date(y, m-1, d);
}
function fmtDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function addDays(dateStr, n){
  const d = parseDate(dateStr);
  d.setDate(d.getDate()+n);
  return fmtDate(d);
}
function daysBetweenInclusive(startStr, endStr){
  const a = parseDate(startStr);
  const b = parseDate(endStr);
  const diff = Math.round((b - a) / 86400000);
  return diff + 1;
}
function toHM(min){
  const h = Math.floor(min/60);
  const m = min%60;
  if(h<=0) return `${m}m`;
  if(m===0) return `${h}h`;
  return `${h}h ${m}m`;
}
function timeToMin(t){ // "HH:MM"
  if(!t) return null;
  const [h,m] = t.split(':').map(Number);
  if(Number.isNaN(h)||Number.isNaN(m)) return null;
  return h*60 + m;
}
function minToTime(min){
  min = ((min%1440)+1440)%1440;
  const h = String(Math.floor(min/60)).padStart(2,'0');
  const m = String(min%60).padStart(2,'0');
  return `${h}:${m}`;
}
function todayStr(){
  const d = new Date();
  return fmtDate(d);
}

/* ---------------------------
   Initialize days if empty
---------------------------- */
function ensureDays(){
  const n = daysBetweenInclusive(state.trip.startDate, state.trip.endDate);
  if(!Array.isArray(state.days) || state.days.length !== n){
    const newDays = [];
    for(let i=0;i<n;i++){
      const date = addDays(state.trip.startDate, i);
      newDays.push({
        date,
        items: []
      });
    }
    // try migrate existing items by date if possible
    const byDate = new Map((state.days||[]).map(d=>[d.date,d]));
    for(const d of newDays){
      if(byDate.has(d.date)){
        d.items = (byDate.get(d.date).items||[]);
      }
    }
    state.days = newDays;
    state.selectedDay = Math.min(state.selectedDay||0, n-1);
    saveState();
  }
}
ensureDays();

/* ---------------------------
   Auto push time logic
---------------------------- */
function recalcFrom(dayIndex, startItemIndex){
  const day = state.days[dayIndex];
  if(!day) return;
  const items = day.items;

  // If startItemIndex out of range, just normalize order by start time
  if(items.length===0) return;

  // keep current order; but ensure stable ordering (start time, then insertion)
  // Do NOT reorder automatically; users may rely on list order
  // We'll only push forward based on list order.

  let t = null;
  if(startItemIndex <= 0){
    const first = items[0];
    t = timeToMin(first.start) ?? 9*60;
    if(!first.start) first.start = minToTime(t);
  }else{
    // base on previous item
    const prev = items[startItemIndex-1];
    const prevStart = timeToMin(prev.start);
    const prevStay = Number(prev.stayMin ?? 0);
    const prevTravel = Number(prev.travelToNextMin ?? 0);
    if(prevStart==null){
      prev.start = '09:00';
      t = 9*60 + prevStay + prevTravel;
    }else{
      t = prevStart + prevStay + prevTravel;
    }
  }

  for(let i=startItemIndex;i<items.length;i++){
    const it = items[i];

    if(it.locked){
      // locked item: do not change it, but reset t based on its own time for next propagation
      const fixed = timeToMin(it.start);
      if(fixed!=null){
        t = fixed + Number(it.stayMin ?? 0) + Number(it.travelToNextMin ?? 0);
      }else{
        // locked but empty time -> fill it, then continue
        it.start = minToTime(t);
        t = t + Number(it.stayMin ?? 0) + Number(it.travelToNextMin ?? 0);
      }
      continue;
    }

    // not locked -> set its start = t
    it.start = minToTime(t);
    t = t + Number(it.stayMin ?? 0) + Number(it.travelToNextMin ?? 0);
  }

  saveState();
}

function setDefaultTimesForNewItem(dayIndex){
  const day = state.days[dayIndex];
  const items = day.items;
  if(items.length===0) return '09:00';
  const last = items[items.length-1];
  const base = timeToMin(last.start) ?? 9*60;
  const next = base + Number(last.stayMin ?? 0) + Number(last.travelToNextMin ?? 0);
  return minToTime(next);
}

/* ---------------------------
   Geo helpers + route estimation
---------------------------- */
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (x)=>x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function estimateMinutesByMode(km, mode){
  // conservative averages
  if(mode==='walk') return Math.max(1, Math.round(km / 4.8 * 60));
  if(mode==='drive') return Math.max(2, Math.round(km / 35 * 60));
  return Math.max(3, Math.round(km / 20 * 60)); // transit
}

async function geocodeNominatim(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=zh-TW&q=${encodeURIComponent(q)}`;
  const res = await fetch(url, { method:'GET' });
  if(!res.ok) throw new Error('å®šä½å¤±æ•—ï¼ˆç¶²è·¯/æœå‹™ï¼‰');
  const arr = await res.json();
  if(!arr || !arr[0]) throw new Error('æ‰¾ä¸åˆ°çµæœ');
  return {
    lat: Number(arr[0].lat),
    lon: Number(arr[0].lon),
    address: arr[0].display_name || q,
    name: q
  };
}

function googleMapsDirectionsUrl(from, to, mode){
  // mode: walking | driving | transit
  const travelmode = mode==='walk' ? 'walking' : (mode==='drive' ? 'driving' : 'transit');
  const origin = `${from.lat},${from.lon}`;
  const dest = `${to.lat},${to.lon}`;
  return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=${travelmode}`;
}

/* ---------------------------
   Currency rate (daily refresh, no key)
   Source endpoint: @fawazahmed0/currency-api (jsDelivr)
---------------------------- */
async function fetchRateToTWD(fromCurrency){
  const base = fromCurrency.toLowerCase();
  const url = `https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${base}.json`;
  const res = await fetch(url, { method:'GET' });
  if(!res.ok) throw new Error('åŒ¯ç‡å–å¾—å¤±æ•—');
  const data = await res.json();
  const twd = data?.[base]?.twd;
  if(!twd) throw new Error('åŒ¯ç‡è³‡æ–™ç¼ºå°‘ TWD');
  return Number(twd);
}
async function refreshRateIfNeeded(force=false){
  if(!state.money.autoRate && !force) return;
  const t = todayStr();
  if(!force && state.money.lastRateDate === t) return;

  try{
    const rate = await fetchRateToTWD(state.money.currency);
    // rate: 1 currency -> TWD
    state.money.exchangeRate = Number(rate.toFixed(4));
    state.money.lastRateDate = t;
    saveState();
    snack('åŒ¯ç‡å·²æ›´æ–°ï¼ˆæ¯æ—¥ä¸€æ¬¡ï¼‰');
    render();
  }catch(e){
    snack('åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼š' + (e.message || ''));
  }
}

/* ---------------------------
   UI helpers
---------------------------- */
const appEl = document.getElementById('app');
const snackEl = document.getElementById('snack');

function snack(msg){
  snackEl.textContent = msg;
  snackEl.style.display = 'block';
  clearTimeout(snackEl._t);
  snackEl._t = setTimeout(()=>snackEl.style.display='none', 2200);
}

function esc(s){
  return String(s ?? '').replace(/[&<>"']/g, (c)=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function daysCount(){
  return daysBetweenInclusive(state.trip.startDate, state.trip.endDate);
}

/* ---------------------------
   Flights view-model for current day:
   - If a leg arrives next day, show depart on D1, arrival on D2.
---------------------------- */
function getFlightCardsForDay(dateStr){
  const cards = [];
  const groups = [
    { key:'outbound', label:'å»ç¨‹' },
    { key:'inbound', label:'å›ç¨‹' }
  ];
  for(const g of groups){
    const legs = state.flights[g.key] || [];
    legs.forEach((leg, idx)=>{
      if(!leg || !leg.departDate || !leg.departTime) return;

      const departDate = leg.departDate;
      const arriveDate = leg.arriveNextDay ? addDays(departDate, 1) : departDate;

      const depMin = timeToMin(leg.departTime) ?? 0;
      const arrMin = timeToMin(leg.arriveTime) ?? depMin;
      let durationMin = arrMin - depMin;
      if(leg.arriveNextDay || durationMin < 0) durationMin += 1440;

      const meta = {
        group: g.label,
        idx: idx+1,
        flightNo: leg.flightNo || '',
        from: leg.from || '',
        to: leg.to || '',
        departTime: leg.departTime || '',
        arriveTime: leg.arriveTime || '',
        arriveNextDay: leg.arriveNextDay || (timeToMin(leg.arriveTime) < timeToMin(leg.departTime)),
        durationMin
      };

      // show depart-only on depart day if crosses day
      if(departDate === dateStr){
        cards.push({ type:'depart', ...meta, arriveDate });
      }
      // show arrive-only on arrival day if crosses day
      if(arriveDate === dateStr && arriveDate !== departDate){
        cards.push({ type:'arrive', ...meta, departDate });
      }
      // if same day, show full card once
      if(arriveDate === departDate && departDate === dateStr){
        cards.push({ type:'same', ...meta });
      }
    });
  }
  return cards;
}

/* ---------------------------
   Rendering
---------------------------- */
function render(){
  ensureDays();

  const trip = state.trip;
  const dcnt = daysCount();
  const day = state.days[state.selectedDay];
  const dateStr = day?.date || trip.startDate;

  const headerHtml = `
    <div class="topbar">
      <div class="topbar-row">
        <button class="iconbtn" data-act="back" aria-label="Back">â†</button>

        <div class="titlebox">
          <div class="title">${esc(trip.name)} <span class="muted" style="font-weight:900;opacity:.9;">${dcnt}å¤©</span></div>
          <div class="subtitle">${esc(trip.startDate)} ï¼ ${esc(trip.endDate)}</div>
        </div>

        <div class="seg-actions" aria-label="Top Actions">
          <button class="${state.view==='plan'?'active':''}" data-view="plan" title="è¡Œç¨‹">
            <span class="glyph">ğŸ“…</span>
          </button>
          <button class="${state.view==='translate'?'active':''}" data-view="translate" title="ç¿»è­¯">
            <span class="glyph">æ–‡A</span>
          </button>
          <button class="${state.view==='money'?'active':''}" data-view="money" title="æ”¯å‡º">
            <span class="glyph">$</span>
          </button>
        </div>
      </div>

      <div class="daystrip" aria-label="Days">
        ${state.days.map((d,i)=>`
          <div class="daychip ${i===state.selectedDay?'active':''}" data-day="${i}">
            <div class="date">${esc(d.date.slice(5))}</div>
            <div class="dnum">D${i+1}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  const planHtml = renderPlan(day);
  const translateHtml = renderTranslate();
  const moneyHtml = renderMoney();

  const bodyHtml = `
    ${headerHtml}
    <div class="content">
      ${state.view==='plan' ? planHtml : ''}
      ${state.view==='translate' ? translateHtml : ''}
      ${state.view==='money' ? moneyHtml : ''}
    </div>

    <div class="bottomnav" role="navigation" aria-label="Bottom Navigation">
      <div class="navrow">
        <button class="navbtn ${state.view==='plan'?'active':''}" data-view="plan"><span class="glyph">ğŸ“…</span>è¡Œç¨‹</button>
        <button class="navbtn ${state.view==='translate'?'active':''}" data-view="translate"><span class="glyph">æ–‡A</span>ç¿»è­¯</button>
        <button class="navbtn ${state.view==='money'?'active':''}" data-view="money"><span class="glyph">$</span>æ”¯å‡º</button>
      </div>
    </div>

    ${state.view==='plan' ? `<button class="fab" data-act="addItem" aria-label="Add">ï¼‹</button>` : ''}
  `;

  appEl.innerHTML = bodyHtml;

  // hide boot screen after successful render
  const boot = document.getElementById('boot');
  boot.style.display = 'none';
}

function renderPlan(day){
  if(!day) return `<div class="card"><div class="card-hd"><h3>æ‰¾ä¸åˆ°æ—¥æœŸ</h3></div></div>`;

  const flightCards = getFlightCardsForDay(day.date);
  const flightHtml = flightCards.length ? `
    <div class="card flight">
      <div class="card-hd">
        <h3>èˆªç­</h3>
        <button class="btn outline" data-act="openFlights">è¨­å®š</button>
      </div>
      <div class="card-bd" style="padding-top:0;">
        ${flightCards.map(c=>{
          if(c.type==='depart'){
            return `
              <div class="card" style="margin-top:10px;border-radius:18px;">
                <div class="flight-inner">
                  <div class="flight-side">
                    <div class="flight-time">${esc(c.departTime)}</div>
                    <div class="flight-label">èµ·é£›</div>
                    <div class="flight-air">${esc(c.from)}</div>
                  </div>
                  <div class="flight-mid">
                    <div class="plane">âœˆï¸</div>
                    <div class="no">${esc(c.flightNo || (c.group+' '+c.idx))}</div>
                    <div class="dur">${toHM(c.durationMin)}</div>
                  </div>
                  <div class="flight-side" style="text-align:right;">
                    <div class="flight-time muted">â€”</div>
                    <div class="flight-label">æŠµé”ï¼ˆéš”å¤©ï¼‰</div>
                    <div class="flight-air">${esc(c.to)}</div>
                  </div>
                </div>
              </div>
            `;
          }
          if(c.type==='arrive'){
            return `
              <div class="card" style="margin-top:10px;border-radius:18px;">
                <div class="flight-inner">
                  <div class="flight-side">
                    <div class="flight-time muted">â€”</div>
                    <div class="flight-label">èµ·é£›ï¼ˆå‰ä¸€å¤©ï¼‰</div>
                    <div class="flight-air">${esc(c.from)}</div>
                  </div>
                  <div class="flight-mid">
                    <div class="plane">âœˆï¸</div>
                    <div class="no">${esc(c.flightNo || (c.group+' '+c.idx))}</div>
                    <div class="dur">${toHM(c.durationMin)}</div>
                  </div>
                  <div class="flight-side" style="text-align:right;">
                    <div class="flight-time">${esc(c.arriveTime)}<span class="arrive-big">æŠµé” +1æ—¥</span></div>
                    <div class="flight-label">æŠµé”</div>
                    <div class="flight-air">${esc(c.to)}</div>
                  </div>
                </div>
              </div>
            `;
          }
          // same-day
          return `
            <div class="card" style="margin-top:10px;border-radius:18px;">
              <div class="flight-inner">
                <div class="flight-side">
                  <div class="flight-time">${esc(c.departTime)}</div>
                  <div class="flight-label">èµ·é£›</div>
                  <div class="flight-air">${esc(c.from)}</div>
                </div>
                <div class="flight-mid">
                  <div class="plane">âœˆï¸</div>
                  <div class="no">${esc(c.flightNo || (c.group+' '+c.idx))}</div>
                  <div class="dur">${toHM(c.durationMin)}</div>
                </div>
                <div class="flight-side" style="text-align:right;">
                  <div class="flight-time">${esc(c.arriveTime)}</div>
                  <div class="flight-label">æŠµé”</div>
                  <div class="flight-air">${esc(c.to)}</div>
                </div>
              </div>
            </div>
          `;
        }).join('')}
        <div class="muted" style="margin-top:10px;font-size:12px;font-weight:900;">
          è·¨æ—¥èˆªç­ï¼šD1 åªé¡¯ç¤ºèµ·é£›ï¼ŒD2 é¡¯ç¤ºæŠµé”ï¼ˆ+1æ—¥ï¼‰ã€‚
        </div>
      </div>
    </div>
  ` : `
    <div class="card flight">
      <div class="card-hd">
        <h3>èˆªç­</h3>
        <button class="btn outline" data-act="openFlights">è¨­å®š</button>
      </div>
      <div class="card-bd muted" style="padding-top:0;font-weight:900;">
        å°šæœªè¨­å®šèˆªç­ï¼ˆå¯é¸å¡«ï¼‰ã€‚
      </div>
    </div>
  `;

  const itemsHtml = day.items.map((it, idx)=>{
    const located = it.place?.lat!=null && it.place?.lon!=null;
    const addr = it.place?.address || '';
    const category = it.category || 'æ™¯é»';

    // route block to next item if both located
    let routeBlock = '';
    const next = day.items[idx+1];
    if(next && located && next.place?.lat!=null && next.place?.lon!=null){
      const km = haversineKm(it.place.lat, it.place.lon, next.place.lat, next.place.lon);
      const walk = estimateMinutesByMode(km, 'walk');
      const drive = estimateMinutesByMode(km, 'drive');
      const transit = estimateMinutesByMode(km, 'transit');
      const mode = it.routeMode || state.routeModeDefault || 'walk';
      const selectedMin = mode==='walk' ? walk : (mode==='drive' ? drive : transit);

      // if user never set travel time, set it to estimate
      const travelMin = Number(it.travelToNextMin ?? selectedMin);

      routeBlock = `
        <div class="route">
          <div class="route-top">
            <div class="muted" style="font-weight:1000;">è·¯ç·šï¼ˆåˆ°ä¸‹ä¸€å€‹ï¼‰</div>
            <button class="btn outline" data-act="openGmaps" data-day="${state.selectedDay}" data-idx="${idx}" data-mode="${mode}">Google Maps</button>
          </div>

          <div class="route-modes">
            <div class="modechip ${mode==='walk'?'active':''}" data-act="setRouteMode" data-day="${state.selectedDay}" data-idx="${idx}" data-mode="walk">ğŸš¶ ${walk} åˆ†</div>
            <div class="modechip ${mode==='drive'?'active':''}" data-act="setRouteMode" data-day="${state.selectedDay}" data-idx="${idx}" data-mode="drive">ğŸš— ${drive} åˆ†</div>
            <div class="modechip ${mode==='transit'?'active':''}" data-act="setRouteMode" data-day="${state.selectedDay}" data-idx="${idx}" data-mode="transit">ğŸš‡ ${transit} åˆ†</div>
          </div>

          <div class="route-bottom">
            <div class="pill">
              <span class="hint">é–“éš”</span>
              <input type="number" min="0" step="1" value="${travelMin}" data-field="travelToNextMin" data-day="${state.selectedDay}" data-idx="${idx}" /> <span class="muted">min</span>
            </div>
            <div class="muted" style="font-weight:900;font-size:12px;">è·é›¢ç´„ ${km.toFixed(2)} kmï¼ˆä¼°ç®—ï¼‰</div>
          </div>
        </div>
      `;
    }

    const stayMin = Number(it.stayMin ?? 0);

    return `
      <div class="item" data-day="${state.selectedDay}" data-idx="${idx}">
        <div class="timebox">
          <input class="timeinput" type="time" value="${esc(it.start || '')}" data-field="start" />
          <button class="smallbtn" data-act="quickEditTime">ä¿®æ”¹</button>
        </div>

        <div class="meta">
          <div class="topline">
            <input class="titleinput" placeholder="è¡Œç¨‹åç¨±â€¦" value="${esc(it.title||'')}" data-field="title" />
            <span class="badge">${esc(category)}</span>
          </div>

          <div class="place">
            <span class="pin">ğŸ“</span>
            <input class="tf" style="padding:10px 12px;font-weight:900;" placeholder="åœ°é»ï¼ˆè¼¸å…¥åº—å/æ™¯é»ï¼Œæœƒå˜—è©¦è‡ªå‹•å®šä½ï¼‰"
              value="${esc(it.place?.name||'')}" data-field="placeName" />
          </div>

          <div class="place" style="margin-top:-6px;">
            <span class="muted" style="font-weight:900;">${located ? 'å·²å®šä½' : 'æœªå®šä½'}</span>
            <span class="addr">${esc(addr)}</span>
          </div>

          <div class="item-actions">
            <div class="pill">
              <span class="hint">åœç•™</span>
              <input type="number" min="0" step="5" value="${stayMin}" data-field="stayMin" /> <span class="muted">min</span>
            </div>

            <div class="switch">
              <span>é–å®šæ™‚é–“</span>
              <input type="checkbox" ${it.locked ? 'checked':''} data-field="locked" />
            </div>

            <button class="trash" data-act="removeItem" title="åˆªé™¤">ğŸ—‘</button>
          </div>

          <div class="chips" aria-label="Category Selector">
            ${CATEGORIES.map(c=>`
              <div class="chip ${c===category?'active':''}" data-act="setCategory" data-day="${state.selectedDay}" data-idx="${idx}" data-cat="${c}">
                ${c}
              </div>
            `).join('')}
          </div>

          ${routeBlock}
        </div>
      </div>
    `;
  }).join('');

  return `
    ${renderTripSettingsCard()}
    ${renderQuickTipsCard()}
    ${renderFlightsCardButtonOnly()}
    ${flightHtml}

    <div class="card">
      <div class="card-hd">
        <h3>ç•¶æ—¥è¡Œç¨‹ï¼ˆ${esc(day.date)} / D${state.selectedDay+1}ï¼‰</h3>
        <button class="btn outline" data-act="addItem">æ–°å¢è¡Œç¨‹</button>
      </div>
      <div class="card-bd" style="padding-top:0;">
        ${day.items.length ? itemsHtml : `<div class="muted" style="font-weight:900;">å°šæœªæ–°å¢è¡Œç¨‹ã€‚æŒ‰ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹ã€‚</div>`}
      </div>
    </div>
  `;
}

function renderTripSettingsCard(){
  const t = state.trip;
  return `
    <div class="card">
      <div class="card-hd"><h3>è¡Œç¨‹åŸºæœ¬è¨­å®š</h3></div>
      <div class="card-bd">
        <div class="row">
          <div class="col" style="flex:1;">
            <div class="label">ç›®çš„åœ°åç¨±</div>
            <input class="tf" value="${esc(t.name)}" data-field="trip.name" />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="col" style="flex:1;">
            <div class="label">é–‹å§‹æ—¥æœŸ</div>
            <input class="tf" type="date" value="${esc(t.startDate)}" data-field="trip.startDate" />
          </div>
          <div class="col" style="flex:1;">
            <div class="label">çµæŸæ—¥æœŸ</div>
            <input class="tf" type="date" value="${esc(t.endDate)}" data-field="trip.endDate" />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn tonal" data-act="applyTripDates">å¥—ç”¨æ—¥æœŸï¼ˆé‡å»ºå¤©æ•¸ï¼‰</button>
          <span class="muted" style="font-weight:900;font-size:12px;">è‹¥ä½ æ”¹äº†æ—¥æœŸç¯„åœï¼Œéœ€è¦æŒ‰é€™å€‹é‡å»º D1~Dnã€‚</span>
        </div>
      </div>
    </div>
  `;
}

function renderQuickTipsCard(){
  return `
    <div class="card">
      <div class="card-hd"><h3>è‡ªå‹•æ¨æ™‚é–“æ€éº¼ç”¨</h3></div>
      <div class="card-bd muted" style="font-weight:900;">
        1) è¨­ã€Œåœç•™ï¼ˆminï¼‰ã€èˆ‡ã€Œè·¯ç·šé–“éš”ï¼ˆminï¼‰ã€å¾Œï¼Œå¾Œé¢è¡Œç¨‹æœƒè‡ªå‹•å¾€å¾Œæ¨ã€‚<br>
        2) é–‹å•Ÿã€Œé–å®šæ™‚é–“ã€ï¼šé€™ç­†è¡Œç¨‹æ™‚é–“å›ºå®šï¼Œä¸æœƒè¢«æ¨å‹•ã€‚<br>
        3) å…©é»éƒ½å·²å®šä½æ™‚ï¼Œæœƒé¡¯ç¤º ğŸš¶/ğŸš—/ğŸš‡ ä¼°ç®—æ™‚é–“ä¸¦å¯ä¸€éµé–‹ Google Mapsã€‚
      </div>
    </div>
  `;
}

function renderFlightsCardButtonOnly(){
  return `
    <div class="card" style="display:none;"></div>
  `;
}

function renderTranslate(){
  const tr = state.translate;
  const quick = [
    'è«‹å•é€™è£¡æ€éº¼å»ï¼Ÿ',
    'æˆ‘è¦é»é¤ï¼Œè¬è¬ã€‚',
    'å¯ä»¥åˆ·å¡å—ï¼Ÿ',
    'é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ',
    'æˆ‘æƒ³è¦ä¸€ä»½ä¸è¾£ã€‚',
    'è«‹å¹«æˆ‘å«è¨ˆç¨‹è»Šã€‚'
  ];
  return `
    <div class="card">
      <div class="card-hd">
        <h3>ç¿»è­¯ï¼ˆå…é‡‘é‘°ï¼‰</h3>
        <button class="btn outline" data-act="swapLang">äº¤æ›</button>
      </div>
      <div class="card-bd">
        <div class="row">
          <div class="col" style="flex:1;">
            <div class="label">ä¾†æºèªè¨€</div>
            <select class="select" data-field="translate.sl">
              ${renderLangOptions(tr.sl)}
            </select>
          </div>
          <div class="col" style="flex:1;">
            <div class="label">ç›®æ¨™èªè¨€</div>
            <select class="select" data-field="translate.tl">
              ${renderLangOptions(tr.tl)}
            </select>
          </div>
        </div>

        <div class="col" style="margin-top:10px;">
          <div class="label">è¼¸å…¥æ–‡å­—</div>
          <textarea class="tf" rows="5" data-field="translate.text" placeholder="è¼¸å…¥è¦ç¿»è­¯çš„å¥å­â€¦">${esc(tr.text||'')}</textarea>
        </div>

        <div class="chips" style="margin-top:10px;">
          ${quick.map(t=>`<div class="chip" data-act="quickPhrase" data-text="${esc(t)}">${esc(t)}</div>`).join('')}
        </div>

        <div class="row" style="margin-top:12px;flex-wrap:wrap;">
          <button class="btn" data-act="openGoogleTranslate">ç”¨ Google ç¿»è­¯é–‹å•Ÿ</button>
          <button class="btn tonal" data-act="openChatGPTTranslate">ç”¨ ChatGPTï¼ˆè¤‡è£½æç¤ºè©ï¼‰</button>
          <button class="btn outline" data-act="clearTranslate">æ¸…ç©º</button>
        </div>

        <div class="muted" style="margin-top:10px;font-size:12px;font-weight:900;">
          Google Translateï¼šç›´æ¥é–‹ç¶²é å¸¶å…¥æ–‡å­—ï¼ˆä¸åƒ APIã€ä¸ç”¨é‡‘é‘°ï¼‰ã€‚<br>
          ChatGPTï¼šä¸èµ°é‡‘é‘°ï¼Œæ”¹æˆã€Œè¤‡è£½æç¤ºè©ã€â†’ è‡ªå‹•é–‹ ChatGPT ç¶²é  â†’ ä½ è²¼ä¸Šé€å‡ºã€‚
        </div>
      </div>
    </div>
  `;
}

function renderLangOptions(selected){
  const langs = [
    ['zh-TW','ç¹ä¸­'],
    ['en','è‹±æ–‡'],
    ['ja','æ—¥æ–‡'],
    ['ko','éŸ“æ–‡'],
    ['th','æ³°æ–‡'],
    ['vi','è¶Šå—æ–‡'],
    ['fr','æ³•æ–‡'],
    ['de','å¾·æ–‡'],
    ['es','è¥¿ç­ç‰™æ–‡']
  ];
  return langs.map(([v,lab])=>`<option value="${v}" ${v===selected?'selected':''}>${lab}</option>`).join('');
}

function renderMoney(){
  const m = state.money;
  const totalsByDay = new Array(state.days.length).fill(0);
  let total = 0;

  for(const e of m.expenses){
    const amt = Number(e.amount || 0);
    total += amt;
    if(Number.isInteger(e.dayIndex) && totalsByDay[e.dayIndex]!=null){
      totalsByDay[e.dayIndex] += amt;
    }
  }

  const twdTotal = total * Number(m.exchangeRate || 0);

  return `
    <div class="card">
      <div class="card-hd">
        <h3>ç¸½æ”¯å‡º Total</h3>
        <button class="btn outline" data-act="refreshRate">æ›´æ–°åŒ¯ç‡</button>
      </div>

      <div class="card-bd">
        <div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:1100;font-size:34px;letter-spacing:.3px;">
            ${esc(m.currency)} ${total.toFixed(2)}
          </div>
          <div class="muted" style="font-weight:1000;">â‰ˆ NT$ ${Math.round(twdTotal).toLocaleString()}</div>
        </div>

        <div class="row" style="margin-top:10px;flex-wrap:wrap;">
          <div class="col" style="flex:1;min-width:160px;">
            <div class="label">åŒ¯ç‡ï¼ˆ1 ${esc(m.currency)} â†’ TWDï¼‰</div>
            <input class="tf" type="number" step="0.0001" value="${esc(m.exchangeRate)}" data-field="money.exchangeRate" ${m.autoRate?'disabled':''} />
          </div>
          <div class="col" style="width:140px;">
            <div class="label">å¹£åˆ¥</div>
            <input class="tf" value="${esc(m.currency)}" data-field="money.currency" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;flex-wrap:wrap;">
          <div class="switch">
            <span>è‡ªå‹•æ›´æ–°ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰</span>
            <input type="checkbox" ${m.autoRate?'checked':''} data-field="money.autoRate" />
          </div>
          <div class="muted" style="font-weight:900;font-size:12px;">
            ä¸Šæ¬¡æ›´æ–°ï¼š${esc(m.lastRateDate || 'å°šæœª')}
          </div>
        </div>

        <div class="hr"></div>

        <div style="font-weight:1000;margin-bottom:8px;">æ¯æ—¥é‡‘é¡ï¼ˆä¾ D1~Dnï¼‰</div>
        <div class="card" style="box-shadow:none;border:1px solid rgba(0,0,0,.06);">
          <div class="card-bd" style="padding-top:14px;">
            ${totalsByDay.map((v,i)=>`
              <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.04);">
                <div style="font-weight:1000;">D${i+1} <span class="muted" style="font-weight:900;">(${esc(state.days[i].date.slice(5))})</span></div>
                <div style="font-weight:1100;">${esc(m.currency)} ${v.toFixed(2)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-hd"><h3>æ–°å¢æ”¯å‡º</h3></div>
      <div class="card-bd">
        <div class="row" style="flex-wrap:wrap;">
          <div class="col" style="flex:1;min-width:180px;">
            <div class="label">é …ç›®</div>
            <input class="tf" id="expTitle" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€é–€ç¥¨ã€äº¤é€šâ€¦" />
          </div>
          <div class="col" style="width:150px;">
            <div class="label">é‡‘é¡ï¼ˆ${esc(m.currency)}ï¼‰</div>
            <input class="tf" id="expAmount" type="number" step="0.01" placeholder="0" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;flex-wrap:wrap;">
          <div class="col" style="width:150px;">
            <div class="label">æ­¸å±¬æ—¥æœŸ</div>
            <select class="select" id="expDay">
              ${state.days.map((d,i)=>`<option value="${i}" ${i===state.selectedDay?'selected':''}>D${i+1} (${d.date.slice(5)})</option>`).join('')}
            </select>
          </div>
          <button class="btn" data-act="addExpense">ï¼‹ åŠ å…¥</button>
          <button class="btn outline" data-act="clearExpenses">æ¸…ç©ºæ‰€æœ‰æ”¯å‡º</button>
        </div>

        <div class="hr"></div>

        <div style="font-weight:1000;margin-bottom:8px;">æ”¯å‡ºæ¸…å–®</div>
        ${m.expenses.length ? `
          ${m.expenses.map(e=>`
            <div class="item" style="margin-bottom:10px;">
              <div class="timebox" style="width:78px;flex-basis:78px;">
                <div class="badge">D${(e.dayIndex||0)+1}</div>
              </div>
              <div class="meta">
                <div class="topline">
                  <div style="font-weight:1100;font-size:16px;">${esc(e.title)}</div>
                  <div style="font-weight:1100;">${esc(m.currency)} ${Number(e.amount||0).toFixed(2)}</div>
                </div>
                <button class="trash" data-act="removeExpense" data-id="${esc(e.id)}">ğŸ—‘ åˆªé™¤</button>
              </div>
            </div>
          `).join('')}
        ` : `<div class="muted" style="font-weight:900;">å°šç„¡æ”¯å‡ºã€‚</div>`}
      </div>
    </div>
  `;
}

/* ---------------------------
   Events (delegation)
---------------------------- */
document.addEventListener('click', async (ev)=>{
  const t = ev.target;

  // switch view
  const viewBtn = t.closest('[data-view]');
  if(viewBtn){
    state.view = viewBtn.getAttribute('data-view');
    saveState();
    render();
    if(state.view==='money') refreshRateIfNeeded(false);
    return;
  }

  // day select
  const dayChip = t.closest('[data-day]');
  if(dayChip && dayChip.classList.contains('daychip')){
    state.selectedDay = Number(dayChip.getAttribute('data-day'));
    saveState();
    render();
    return;
  }

  const actEl = t.closest('[data-act]');
  if(!actEl) return;
  const act = actEl.getAttribute('data-act');

  if(act==='applyTripDates'){
    // rebuild days
    ensureDays(); // first align
    const n = daysBetweenInclusive(state.trip.startDate, state.trip.endDate);
    const newDays = [];
    for(let i=0;i<n;i++){
      const date = addDays(state.trip.startDate, i);
      const existing = state.days.find(d=>d.date===date);
      newDays.push({ date, items: existing?.items || [] });
    }
    state.days = newDays;
    state.selectedDay = Math.min(state.selectedDay, n-1);
    saveState();
    render();
    snack('å·²å¥—ç”¨æ—¥æœŸç¯„åœ');
    return;
  }

  if(act==='addItem'){
    const day = state.days[state.selectedDay];
    const start = setDefaultTimesForNewItem(state.selectedDay);
    day.items.push({
      id: uid(),
      title: '',
      start,
      stayMin: 60,
      locked: false,
      category: 'æ™¯é»',
      place: { name:'', address:'', lat:null, lon:null },
      routeMode: state.routeModeDefault,
      travelToNextMin: 0
    });
    // push times from last item (no need)
    saveState();
    render();
    snack('å·²æ–°å¢è¡Œç¨‹');
    return;
  }

  if(act==='removeItem'){
    const wrap = actEl.closest('.item');
    const dayIndex = Number(wrap.getAttribute('data-day'));
    const idx = Number(wrap.getAttribute('data-idx'));
    const day = state.days[dayIndex];
    day.items.splice(idx, 1);
    // recalc from previous
    recalcFrom(dayIndex, Math.max(0, idx-1));
    render();
    snack('å·²åˆªé™¤');
    return;
  }

  if(act==='setCategory'){
    const dayIndex = Number(actEl.getAttribute('data-day'));
    const idx = Number(actEl.getAttribute('data-idx'));
    const cat = actEl.getAttribute('data-cat');
    state.days[dayIndex].items[idx].category = cat;
    saveState();
    render();
    return;
  }

  if(act==='setRouteMode'){
    const dayIndex = Number(actEl.getAttribute('data-day'));
    const idx = Number(actEl.getAttribute('data-idx'));
    const mode = actEl.getAttribute('data-mode');
    const day = state.days[dayIndex];
    const it = day.items[idx];
    it.routeMode = mode;

    // when change mode, set travel time to estimate and auto-push
    const next = day.items[idx+1];
    if(next && it.place?.lat!=null && next.place?.lat!=null){
      const km = haversineKm(it.place.lat, it.place.lon, next.place.lat, next.place.lon);
      it.travelToNextMin = estimateMinutesByMode(km, mode);
      recalcFrom(dayIndex, idx+1);
    }
    saveState();
    render();
    return;
  }

  if(act==='openGmaps'){
    const dayIndex = Number(actEl.getAttribute('data-day'));
    const idx = Number(actEl.getAttribute('data-idx'));
    const mode = actEl.getAttribute('data-mode') || 'walk';
    const day = state.days[dayIndex];
    const it = day.items[idx];
    const next = day.items[idx+1];
    if(!(it?.place?.lat!=null && next?.place?.lat!=null)){
      snack('è«‹å…ˆå®Œæˆå…©é»å®šä½');
      return;
    }
    const url = googleMapsDirectionsUrl(it.place, next.place, mode);
    window.open(url, '_blank');
    return;
  }

  if(act==='openFlights'){
    openFlightsDialog();
    return;
  }

  if(act==='swapLang'){
    const a = state.translate.sl;
    state.translate.sl = state.translate.tl;
    state.translate.tl = a;
    saveState();
    render();
    return;
  }

  if(act==='quickPhrase'){
    state.translate.text = actEl.getAttribute('data-text') || '';
    saveState();
    render();
    return;
  }

  if(act==='openGoogleTranslate'){
    const {sl, tl, text} = state.translate;
    if(!text.trim()){ snack('è«‹å…ˆè¼¸å…¥æ–‡å­—'); return; }
    const url = `https://translate.google.com/?sl=${encodeURIComponent(sl)}&tl=${encodeURIComponent(tl)}&text=${encodeURIComponent(text)}&op=translate`;
    window.open(url, '_blank');
    return;
  }

  if(act==='openChatGPTTranslate'){
    const {sl, tl, text} = state.translate;
    if(!text.trim()){ snack('è«‹å…ˆè¼¸å…¥æ–‡å­—'); return; }
    const prompt = `è«‹æŠŠä»¥ä¸‹å…§å®¹ç¿»è­¯æˆã€Œ${tl}ã€ï¼Œèªæ°£è‡ªç„¶ã€åƒç•¶åœ°äººæœƒèªªçš„å¥å­ï¼›å¦‚æœæœ‰æ›´è‡ªç„¶çš„èªªæ³•ï¼Œè«‹çµ¦ 2 å€‹ç‰ˆæœ¬ï¼š\\n\\nã€åŸæ–‡ (${sl})ã€‘\\n${text}`;
    try{
      await navigator.clipboard.writeText(prompt);
      snack('å·²è¤‡è£½æç¤ºè©ï¼šæ‰“é–‹ ChatGPT ç›´æ¥è²¼ä¸Šé€å‡º');
    }catch{
      snack('è¤‡è£½å¤±æ•—ï¼šè«‹æ‰‹å‹•é•·æŒ‰å…¨é¸è¤‡è£½');
    }
    window.open('https://chatgpt.com/', '_blank');
    return;
  }

  if(act==='clearTranslate'){
    state.translate.text = '';
    saveState();
    render();
    return;
  }

  if(act==='refreshRate'){
    await refreshRateIfNeeded(true);
    return;
  }

  if(act==='addExpense'){
    const titleEl = document.getElementById('expTitle');
    const amtEl = document.getElementById('expAmount');
    const dayEl = document.getElementById('expDay');
    const title = (titleEl?.value || '').trim();
    const amount = Number(amtEl?.value || 0);
    const dayIndex = Number(dayEl?.value || state.selectedDay);

    if(!title){ snack('è«‹è¼¸å…¥é …ç›®'); return; }
    if(!(amount>0)){ snack('é‡‘é¡è¦å¤§æ–¼ 0'); return; }

    state.money.expenses.unshift({ id: uid(), dayIndex, title, amount });
    saveState();
    render();
    snack('å·²åŠ å…¥æ”¯å‡º');
    return;
  }

  if(act==='removeExpense'){
    const id = actEl.getAttribute('data-id');
    state.money.expenses = state.money.expenses.filter(e=>e.id!==id);
    saveState();
    render();
    snack('å·²åˆªé™¤æ”¯å‡º');
    return;
  }

  if(act==='clearExpenses'){
    if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ”¯å‡ºï¼Ÿ')){
      state.money.expenses = [];
      saveState();
      render();
      snack('å·²æ¸…ç©º');
    }
    return;
  }
});

document.addEventListener('input', (ev)=>{
  const el = ev.target;
  const field = el.getAttribute('data-field');
  if(!field) return;

  // Trip fields
  if(field.startsWith('trip.')){
    const k = field.split('.')[1];
    state.trip[k] = el.value;
    saveState();
    return;
  }

  // Translate fields
  if(field.startsWith('translate.')){
    const k = field.split('.')[1];
    state.translate[k] = el.value;
    saveState();
    return;
  }

  // Money fields
  if(field.startsWith('money.')){
    const k = field.split('.')[1];
    if(k==='autoRate'){
      state.money.autoRate = el.checked;
      saveState();
      render();
      if(state.money.autoRate) refreshRateIfNeeded(true);
      return;
    }
    if(k==='exchangeRate'){
      state.money.exchangeRate = Number(el.value || 0);
      saveState();
      return;
    }
    if(k==='currency'){
      state.money.currency = (el.value || 'NZD').toUpperCase();
      saveState();
      // do not spam fetch on each keystroke
      return;
    }
  }

  // Item fields (delegation via closest .item)
  const wrap = el.closest('.item');
  if(!wrap) return;
  const dayIndex = Number(wrap.getAttribute('data-day'));
  const idx = Number(wrap.getAttribute('data-idx'));
  const day = state.days[dayIndex];
  const it = day.items[idx];

  if(field==='title'){
    it.title = el.value;
    saveState();
    return;
  }

  if(field==='start'){
    it.start = el.value;
    // if user edits time manually, treat as locked? keep their switch separate
    recalcFrom(dayIndex, idx+1);
    render();
    return;
  }

  if(field==='stayMin'){
    it.stayMin = Math.max(0, Number(el.value || 0));
    recalcFrom(dayIndex, idx+1);
    render();
    return;
  }

  if(field==='locked'){
    it.locked = el.checked;
    saveState();
    render();
    return;
  }

  if(field==='placeName'){
    it.place = it.place || {};
    it.place.name = el.value;
    saveState();
    return;
  }

  if(field==='travelToNextMin'){
    it.travelToNextMin = Math.max(0, Number(el.value || 0));
    recalcFrom(dayIndex, idx+1);
    render();
    return;
  }
});

document.addEventListener('change', async (ev)=>{
  const el = ev.target;
  const field = el.getAttribute('data-field');
  if(!field) return;

  // When currency edited and user leaves field: refresh rate
  if(field==='money.currency'){
    state.money.currency = (el.value || 'NZD').toUpperCase();
    saveState();
    if(state.money.autoRate) await refreshRateIfNeeded(true);
    render();
    return;
  }

  // Place geocode on blur-like behavior: use change event (mobile friendly)
  if(field==='placeName'){
    const wrap = el.closest('.item');
    if(!wrap) return;
    const dayIndex = Number(wrap.getAttribute('data-day'));
    const idx = Number(wrap.getAttribute('data-idx'));
    const it = state.days[dayIndex].items[idx];
    const q = (it.place?.name || '').trim();
    if(!q) return;

    snack('å®šä½ä¸­â€¦');
    try{
      const g = await geocodeNominatim(q);
      it.place = { ...it.place, ...g };
      saveState();
      render();

      // if next exists and both located, auto fill travel estimate
      const day = state.days[dayIndex];
      const next = day.items[idx+1];
      if(next?.place?.lat!=null){
        const km = haversineKm(it.place.lat, it.place.lon, next.place.lat, next.place.lon);
        const mode = it.routeMode || state.routeModeDefault || 'walk';
        it.travelToNextMin = estimateMinutesByMode(km, mode);
        recalcFrom(dayIndex, idx+1);
        saveState();
        render();
      }
      // if prev exists and both located, update prev segment estimate
      const prev = state.days[dayIndex].items[idx-1];
      if(prev?.place?.lat!=null){
        const km = haversineKm(prev.place.lat, prev.place.lon, it.place.lat, it.place.lon);
        const mode = prev.routeMode || state.routeModeDefault || 'walk';
        prev.travelToNextMin = estimateMinutesByMode(km, mode);
        recalcFrom(dayIndex, idx);
        saveState();
        render();
      }

      snack('å·²å®šä½');
    }catch(e){
      snack('å®šä½å¤±æ•—ï¼š' + (e.message || ''));
    }
  }
});

/* ---------------------------
   Flights dialog
---------------------------- */
const dlgMask = document.getElementById('dlgMask');
const dlgBody = document.getElementById('dlgBody');
document.getElementById('dlgClose').addEventListener('click', closeFlightsDialog);
document.getElementById('dlgCancel').addEventListener('click', closeFlightsDialog);
document.getElementById('dlgSave').addEventListener('click', saveFlightsDialog);

let dlgDraft = null;

function openFlightsDialog(){
  dlgDraft = structuredClone(state.flights);

  dlgBody.innerHTML = `
    <div class="muted" style="font-weight:900;">æç¤ºï¼šè‹¥ã€ŒæŠµé”æ™‚é–“ã€æ—©æ–¼ã€Œèµ·é£›æ™‚é–“ã€ï¼Œå¯å‹¾é¸ã€Œéš”å¤©æŠµé”ã€ã€‚</div>
    <div class="hr"></div>

    ${renderFlightGroup('å»ç¨‹ Outbound', 'outbound', dlgDraft.outbound)}
    <div class="hr"></div>
    ${renderFlightGroup('å›ç¨‹ Inbound', 'inbound', dlgDraft.inbound)}
  `;

  dlgMask.style.display='flex';

  // wire inputs
  dlgBody.querySelectorAll('[data-f]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const key = inp.getAttribute('data-group');
      const idx = Number(inp.getAttribute('data-idx'));
      const f = inp.getAttribute('data-f');
      const val = inp.type==='checkbox' ? inp.checked : inp.value;
      dlgDraft[key][idx][f] = val;

      // auto infer next day if arrive earlier and checkbox not set
      if(f==='arriveTime' || f==='departTime'){
        const dep = timeToMin(dlgDraft[key][idx].departTime);
        const arr = timeToMin(dlgDraft[key][idx].arriveTime);
        if(dep!=null && arr!=null){
          dlgDraft[key][idx].arriveNextDay = (arr < dep);
          const cb = dlgBody.querySelector(\`input[type="checkbox"][data-group="\${key}"][data-idx="\${idx}"][data-f="arriveNextDay"]\`);
          if(cb) cb.checked = dlgDraft[key][idx].arriveNextDay;
        }
      }
    });
  });
}

function renderFlightGroup(title, groupKey, legs){
  return `
    <div style="font-weight:1100;margin-bottom:10px;">${esc(title)}</div>
    ${legs.map((leg, i)=>`
      <div class="card" style="box-shadow:none;border:1px solid rgba(0,0,0,.06);margin-bottom:10px;">
        <div class="card-bd" style="padding-top:14px;">
          <div class="row" style="flex-wrap:wrap;">
            <div class="col" style="flex:1;min-width:160px;">
              <div class="label">èˆªç­è™Ÿ</div>
              <input class="tf" value="${esc(leg.flightNo)}" data-group="${groupKey}" data-idx="${i}" data-f="flightNo" />
            </div>
            <div class="col" style="width:110px;">
              <div class="label">From</div>
              <input class="tf" value="${esc(leg.from)}" data-group="${groupKey}" data-idx="${i}" data-f="from" />
            </div>
            <div class="col" style="width:110px;">
              <div class="label">To</div>
              <input class="tf" value="${esc(leg.to)}" data-group="${groupKey}" data-idx="${i}" data-f="to" />
            </div>
          </div>

          <div class="row" style="flex-wrap:wrap;margin-top:10px;">
            <div class="col" style="flex:1;min-width:170px;">
              <div class="label">èµ·é£›æ—¥æœŸ</div>
              <input class="tf" type="date" value="${esc(leg.departDate)}" data-group="${groupKey}" data-idx="${i}" data-f="departDate" />
            </div>
            <div class="col" style="width:160px;">
              <div class="label">èµ·é£›æ™‚é–“</div>
              <input class="tf" type="time" value="${esc(leg.departTime)}" data-group="${groupKey}" data-idx="${i}" data-f="departTime" />
            </div>
            <div class="col" style="width:160px;">
              <div class="label">æŠµé”æ™‚é–“</div>
              <input class="tf" type="time" value="${esc(leg.arriveTime)}" data-group="${groupKey}" data-idx="${i}" data-f="arriveTime" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;flex-wrap:wrap;">
            <div class="switch">
              <span>éš”å¤©æŠµé”</span>
              <input type="checkbox" ${leg.arriveNextDay?'checked':''} data-group="${groupKey}" data-idx="${i}" data-f="arriveNextDay" />
            </div>
          </div>
        </div>
      </div>
    `).join('')}
  `;
}

function closeFlightsDialog(){
  dlgMask.style.display='none';
  dlgDraft = null;
}

function saveFlightsDialog(){
  if(!dlgDraft) return;
  state.flights = dlgDraft;
  saveState();
  closeFlightsDialog();
  render();
  snack('èˆªç­å·²å„²å­˜');
}

// click outside dialog to close
dlgMask.addEventListener('click', (e)=>{
  if(e.target === dlgMask) closeFlightsDialog();
});

/* ---------------------------
   Service Worker register
---------------------------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* ---------------------------
   First render + rate refresh
---------------------------- */
render();
refreshRateIfNeeded(false);
</script>
</body>
</html>