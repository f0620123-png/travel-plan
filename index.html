<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Travel Plan</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0F766E">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --md-primary:#0F766E;
      --md-primary-2:#115E59;
      --md-surface:#FFFFFF;
      --md-bg:#F1F5F9;
      --md-outline:#E2E8F0;
      --md-text:#0F172A;
      --md-sub:#475569;
      --md-muted:#94A3B8;
      --md-danger:#DC2626;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Roboto, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
      background:var(--md-bg);
      color:var(--md-text);
      -webkit-tap-highlight-color:transparent;
    }
    .app{
      max-width:420px;
      margin:0 auto;
      height:100vh;
      background:var(--md-bg);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* Material-ish surfaces */
    .topbar{
      background:var(--md-primary);
      color:#fff;
      padding:12px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
      position:sticky; top:0; z-index:20;
    }
    .topbar-row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .top-left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .icon-btn{
      width:40px; height:40px;
      border-radius:999px;
      border:none;
      background:rgba(255,255,255,.12);
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .icon-btn:active{transform:scale(.98)}
    .title-block{min-width:0}
    .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      opacity:.85;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .segmented{
      display:flex;
      background:rgba(0,0,0,.15);
      border-radius:14px;
      padding:4px;
      gap:4px;
    }
    .seg-btn{
      width:44px; height:40px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      color:rgba(255,255,255,.9);
      background:transparent;
      display:flex; align-items:center; justify-content:center;
    }
    .seg-btn.active{
      background:#fff;
      color:var(--md-primary);
      box-shadow:0 6px 16px rgba(0,0,0,.18);
    }

    .day-strip{
      display:flex;
      gap:10px;
      overflow:auto;
      padding:10px 10px 12px;
      scroll-snap-type:x mandatory;
    }
    .day-card{
      scroll-snap-align:center;
      min-width:74px;
      height:74px;
      border-radius:18px;
      padding:10px 10px;
      background:rgba(255,255,255,.14);
      color:#fff;
      border:1px solid rgba(255,255,255,.22);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .day-card.active{
      background:#fff;
      color:var(--md-primary);
      border:1px solid rgba(255,255,255,.9);
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      transform:scale(1.03);
    }
    .day-small{font-size:12px; opacity:.9}
    .day-big{font-size:18px; font-weight:800; margin-top:2px}

    .content{
      flex:1;
      overflow:auto;
      padding:14px 14px 90px;
    }

    .md-card{
      background:var(--md-surface);
      border:1px solid var(--md-outline);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 6px 16px rgba(15,23,42,.06);
    }
    .md-card + .md-card{margin-top:12px}
    .hstack{display:flex; align-items:center; gap:10px}
    .vstack{display:flex; flex-direction:column; gap:10px}
    .spacer{flex:1}

    .chip-row{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      border:1px solid var(--md-outline);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--md-sub);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      max-width:100%;
    }
    .chip .material-icons{font-size:16px}
    .chip.active{
      border-color:rgba(15,118,110,.35);
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
      font-weight:600;
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    .label{
      font-size:12px;
      color:var(--md-sub);
      font-weight:600;
      letter-spacing:.2px;
    }
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--md-outline);
      padding:12px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
      color:var(--md-text);
    }
    textarea{min-height:104px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(15,118,110,.45);
      box-shadow:0 0 0 4px rgba(15,118,110,.12);
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-primary{
      background:var(--md-primary);
      color:#fff;
      box-shadow:0 10px 22px rgba(15,118,110,.28);
    }
    .btn-primary:active{transform:scale(.99)}
    .btn-ghost{
      background:#fff;
      color:var(--md-primary);
      border:1px solid rgba(15,118,110,.28);
    }
    .btn-danger{
      background:#fff;
      color:var(--md-danger);
      border:1px solid rgba(220,38,38,.25);
    }

    /* Switch */
    .switch{
      display:flex; align-items:center; gap:10px;
      user-select:none;
      cursor:pointer;
    }
    .switch small{color:var(--md-sub)}
    .toggle{
      width:46px; height:28px;
      border-radius:999px;
      background:#CBD5E1;
      position:relative;
      transition:.2s;
      flex-shrink:0;
    }
    .toggle::after{
      content:"";
      width:22px; height:22px;
      background:#fff;
      border-radius:999px;
      position:absolute;
      top:3px; left:3px;
      transition:.2s;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
    }
    .toggle.on{background:rgba(15,118,110,.55)}
    .toggle.on::after{left:21px}

    /* Items */
    .item{
      display:flex;
      gap:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--md-outline);
      background:#fff;
      box-shadow:0 6px 14px rgba(15,23,42,.05);
    }
    .timebox{
      width:84px;
      border-radius:14px;
      border:1px solid var(--md-outline);
      background:#F8FAFC;
      padding:10px 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex-shrink:0;
    }
    .timebox .t{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:20px;
      font-weight:800;
      line-height:1.1;
    }
    .timebox .sub{
      font-size:11px;
      color:var(--md-muted);
      margin-top:6px;
      display:flex; align-items:center; gap:6px;
    }
    .lock-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      font-size:12px;
      color:var(--md-sub);
      cursor:pointer;
      user-select:none;
    }
    .lock-pill.locked{
      border-color:rgba(15,118,110,.35);
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
      font-weight:700;
    }

    .item-main{flex:1; min-width:0}
    .item-title{
      font-size:16px;
      font-weight:800;
      border:none;
      padding:0;
      margin:0;
      outline:none;
      background:transparent;
      width:100%;
    }
    .loc-row{
      display:flex; gap:8px; align-items:center; margin-top:6px;
      color:var(--md-sub);
      font-size:12px;
    }
    .loc-row .material-icons{font-size:16px; color:rgba(15,118,110,.9)}
    .loc-input{
      border:none; outline:none; background:transparent;
      font-size:12px; width:100%;
      padding:0;
      color:var(--md-sub);
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
      border:1px solid rgba(15,118,110,.22);
      flex-shrink:0;
      white-space:nowrap;
    }
    .icon-mini{
      width:32px; height:32px;
      border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      flex-shrink:0;
      color:var(--md-sub);
    }
    .icon-mini .material-icons{font-size:18px}
    .icon-mini.danger{color:var(--md-danger); border-color:rgba(220,38,38,.25)}

    .meta-row{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .mini-field{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      font-size:12px;
      color:var(--md-sub);
      cursor:pointer;
      user-select:none;
    }

    /* Transport block (spacing improved) */
    .between{
      margin:10px 0 14px;
      padding:12px;
      border-radius:18px;
      border:1px dashed rgba(148,163,184,.55);
      background:rgba(248,250,252,.85);
    }
    .between-top{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .route-row{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .route-chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      width:100%;
    }
    .route-chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--md-outline);
      background:#fff;
      font-size:12px;
      color:var(--md-sub);
      display:inline-flex; align-items:center; gap:6px;
      cursor:pointer;
      user-select:none;
    }
    .route-chip strong{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .route-chip.active{
      border-color:rgba(15,118,110,.35);
      background:rgba(15,118,110,.10);
      color:var(--md-primary);
      font-weight:700;
    }

    /* Flight */
    .flight{
      border-radius:20px;
      padding:14px;
      border:1px solid rgba(2,132,199,.12);
      background:linear-gradient(135deg, rgba(2,132,199,.95), rgba(15,118,110,.95));
      color:#fff;
      box-shadow:0 14px 26px rgba(2,132,199,.18);
    }
    .flight h3{margin:0; font-size:14px; letter-spacing:.3px}
    .flight-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr 110px 1fr;
      gap:10px;
      align-items:center;
    }
    .flight-col{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }
    .flight-col.right{align-items:flex-end}
    .flight-time{
      font-size:26px;
      font-weight:900;
      letter-spacing:.4px;
    }
    .flight-air{
      font-size:13px;
      opacity:.92;
      font-weight:700;
      letter-spacing:.9px;
    }
    .flight-mid{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .flight-mid .plane{
      font-size:22px;
      opacity:.95;
    }
    .pill{
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      border-radius:999px;
      padding:10px 12px;
      text-align:center;
      min-width:110px;
    }
    .pill .big{font-weight:900; font-size:16px; line-height:1.1}
    .pill .small{font-size:12px; opacity:.9; margin-top:4px}
    .flight-actions{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .mini-btn{
      border:1px solid rgba(255,255,255,.26);
      background:rgba(255,255,255,.12);
      color:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .mini-btn:active{transform:scale(.99)}

    /* Bottom sheet time editor */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.4);
      display:flex;
      align-items:flex-end;
      z-index:50;
    }
    .sheet{
      width:100%;
      max-width:420px;
      margin:0 auto;
      background:#fff;
      border-radius:24px 24px 0 0;
      padding:16px;
      box-shadow:0 -18px 40px rgba(0,0,0,.22);
    }
    .sheet-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:6px 2px 12px;
      border-bottom:1px solid var(--md-outline);
    }
    .sheet-title{font-size:16px; font-weight:900}
    .wheel{
      display:flex;
      gap:10px;
      justify-content:center;
      padding:16px 0 8px;
    }
    .wheel select{
      width:120px;
      text-align:center;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:800;
      font-size:18px;
      padding:14px 12px;
      border-radius:18px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      z-index:80;
      max-width:90%;
      text-align:center;
    }

    /* Start screen */
    .start{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:linear-gradient(135deg, var(--md-primary), #0EA5A5);
    }
    .start-card{
      width:100%;
      max-width:420px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.55);
      border-radius:24px;
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.22);
    }
    .start-brand{
      display:flex;
      align-items:center;
      gap:10px;
      color:#0b3b38;
      margin-bottom:10px;
    }
    .start-brand .logo{
      width:44px; height:44px;
      border-radius:16px;
      background:#fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 18px rgba(0,0,0,.14);
      border:1px solid rgba(0,0,0,.05);
    }
    .start-brand .logo .material-icons{color:var(--md-primary); font-size:26px}
    .start-brand .b1{font-weight:900; font-size:18px}
    .start-brand .b2{font-size:12px; opacity:.8}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    a.link{color:inherit; text-decoration:none}
    .muted{color:var(--md-muted)}
  </style>
</head>

<body>
<div id="app"></div>

<script>
  const { createApp, ref, computed, reactive, watch, nextTick, onMounted } = Vue;

  // ---------- helpers ----------
  const pad2 = (n) => String(n).padStart(2,'0');
  const todayISO = () => new Date().toISOString().split('T')[0];
  const timeToMin = (t) => {
    if(!t || !t.includes(':')) return 0;
    const [h,m] = t.split(':').map(x=>parseInt(x,10));
    return (h*60 + m) % 1440;
  };
  const minToTime = (mins) => {
    let m = mins % 1440;
    if (m < 0) m += 1440;
    return `${pad2(Math.floor(m/60))}:${pad2(m%60)}`;
  };
  const durLabel = (mins) => {
    const h = Math.floor(mins/60);
    const m = mins%60;
    if(h<=0) return `${m}min`;
    return `${h}hr ${pad2(m)}min`;
  };

  const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2,6);

  const catDefs = [
    {k:'food',  t:'美食',  icon:'restaurant'},
    {k:'shop',  t:'購物',  icon:'shopping_bag'},
    {k:'stay',  t:'住宿',  icon:'hotel'},
    {k:'fun',   t:'遊樂',  icon:'sports_esports'},
    {k:'trans', t:'交通',  icon:'train'},
    {k:'spot',  t:'景點',  icon:'location_on'},
  ];

  const langDefs = [
    { code:'zh-TW', name:'繁中' },
    { code:'en', name:'英文' },
    { code:'ja', name:'日文' },
    { code:'ko', name:'韓文' },
    { code:'th', name:'泰文' },
    { code:'fr', name:'法文' },
    { code:'de', name:'德文' },
    { code:'es', name:'西文' },
  ];

  // Exchange rate API: no key
  // Use USD base, compute: 1 (currency) = (USD->TWD) / (USD->currency) TWD
  const FX_URL = "https://open.er-api.com/v6/latest/USD";

  createApp({
    setup(){
      // ---------- state ----------
      const STORAGE_KEY = "travel_plan_md_v1";
      const hasStarted = ref(false);

      const setup = ref({
        destination: '',
        startDate: todayISO(),
        endDate: todayISO(),
        currency: 'JPY'
      });

      const viewMode = ref('plan'); // plan | translate | money
      const currentDayIdx = ref(0);

      const days = ref([]);
      const flights = ref([]); // [{id, departDayIdx, arrivalDayIdx, startTime, startAirport, endTime, endAirport, flightNo, arrivalOffset}]
      const expenses = ref([]); // [{id, dayIdx, item, amount:number}]

      // auto time push
      const autoPush = ref(true);

      // exchange
      const exchangeRate = ref(0); // TWD per 1 setup.currency
      const exchangeMeta = ref({ date: '', base: 'USD' });

      // translate
      const tr = ref({
        sl: 'zh-TW',
        tl: 'ja',
        text: '',
      });

      // toast
      const toast = ref({ show:false, text:'' });
      const showToast = (t) => {
        toast.value = { show:true, text:t };
        setTimeout(()=> toast.value.show = false, 1800);
      };

      // wheel editor
      const wheel = reactive({
        show:false,
        mode:'time', // time | stay | transport
        targetIdx: null,
        h:'09', m:'00',
      });

      // ---------- computed ----------
      const totalDays = computed(() => days.value.length);

      const currentDay = computed(() => days.value[currentDayIdx.value] || {
        title:'', date:'', shortDate:'', fullDate:'', items:[]
      });

      const totalExpense = computed(() =>
        expenses.value.reduce((s,e)=> s + (Number(e.amount)||0), 0)
      );

      const dayExpense = computed(() => {
        const map = new Map();
        for (const e of expenses.value){
          const k = e.dayIdx ?? 0;
          map.set(k, (map.get(k)||0) + (Number(e.amount)||0));
        }
        return map;
      });

      // flight display split: depart-only / arrive-only
      const flightForDay = (dayIdx) => {
        const dep = flights.value.filter(f => f.departDayIdx === dayIdx);
        const arr = flights.value.filter(f => f.arrivalDayIdx === dayIdx);
        return { dep, arr };
      };

      // ---------- persistence ----------
      const save = () => {
        const payload = {
          hasStarted: hasStarted.value,
          setup: setup.value,
          viewMode: viewMode.value,
          currentDayIdx: currentDayIdx.value,
          days: days.value,
          flights: flights.value,
          expenses: expenses.value,
          autoPush: autoPush.value,
          exchangeRate: exchangeRate.value,
          exchangeMeta: exchangeMeta.value,
          tr: tr.value
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      };

      const load = () => {
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return;
          const p = JSON.parse(raw);
          hasStarted.value = !!p.hasStarted;
          setup.value = p.setup || setup.value;
          viewMode.value = p.viewMode || 'plan';
          currentDayIdx.value = p.currentDayIdx || 0;
          days.value = p.days || [];
          flights.value = p.flights || [];
          expenses.value = p.expenses || [];
          autoPush.value = (p.autoPush !== undefined) ? p.autoPush : true;
          exchangeRate.value = p.exchangeRate || 0;
          exchangeMeta.value = p.exchangeMeta || { date:'', base:'USD' };
          tr.value = p.tr || tr.value;
        } catch {}
      };

      watch([setup, days, flights, expenses, viewMode, currentDayIdx, autoPush, exchangeRate, exchangeMeta, tr], save, { deep:true });

      // ---------- init trip ----------
      const initTrip = () => {
        if(!setup.value.destination) return alert('請輸入目的地');
        const start = new Date(setup.value.startDate);
        const end = new Date(setup.value.endDate);
        if(end < start) return alert('回程日期不能早於去程日期');

        const diffTime = Math.abs(end - start);
        const count = Math.ceil(diffTime / (1000*60*60*24)) + 1;

        const weekDays = ['日','一','二','三','四','五','六'];
        const arr = [];
        let d = new Date(start);

        for(let i=0;i<count;i++){
          const mm = d.getMonth()+1;
          const dd = d.getDate();
          arr.push({
            shortDate: `${mm}/${dd}`,
            date: `${mm}/${dd} (${weekDays[d.getDay()]})`,
            fullDate: d.toISOString().split('T')[0],
            title: '',
            items: []
          });
          d.setDate(d.getDate()+1);
        }

        days.value = arr;
        flights.value = [];
        expenses.value = [];
        currentDayIdx.value = 0;
        hasStarted.value = true;

        // default item
        addItem();
        fetchExchangeRateIfNeeded(true);
      };

      const addDay = () => {
        if(!days.value.length) return;
        const last = new Date(days.value[days.value.length-1].fullDate);
        last.setDate(last.getDate()+1);
        const weekDays = ['日','一','二','三','四','五','六'];
        days.value.push({
          shortDate: `${last.getMonth()+1}/${last.getDate()}`,
          date: `${last.getMonth()+1}/${last.getDate()} (${weekDays[last.getDay()]})`,
          fullDate: last.toISOString().split('T')[0],
          title: '',
          items: []
        });
        setup.value.endDate = last.toISOString().split('T')[0];
        nextTick(()=> currentDayIdx.value = days.value.length-1);
      };

      // ---------- time auto push ----------
      const recalcFrom = (startIdx=0) => {
        if(!autoPush.value) return;
        const items = currentDay.value.items;
        if(items.length <= 1) return;

        // find an anchor: startIdx itself uses its own time (even if unlocked)
        let i = Math.max(0, startIdx);
        let base = timeToMin(items[i].time);

        for(let k=i; k<items.length-1; k++){
          const cur = items[k];
          const stay = Number(cur.stayMins || 0);
          const trans = Number(cur.transport?.mins || 0);
          const next = items[k+1];

          const nextStart = base + stay + trans;

          if(next.locked){
            base = timeToMin(next.time);
          }else{
            next.time = minToTime(nextStart);
            base = nextStart;
          }
        }
      };

      const addItem = () => {
        const items = currentDay.value.items;
        let t = "09:00";
        if(items.length){
          const last = items[items.length-1];
          const base = timeToMin(last.time);
          const stay = Number(last.stayMins || 0);
          const trans = Number(last.transport?.mins || 0);
          t = minToTime(base + stay + trans);
        }
        items.push({
          id: uid(),
          time: t,
          locked: false,
          activity: '',
          location: '',
          resolved: '',
          lat: null,
          lon: null,
          category: 'spot',
          stayMins: 60,
          transport: { mode:'walk', mins:20, routeMins:{ walk:null, drive:null, transit:null }, lastKey:'' }
        });
        nextTick(()=> recalcFrom(Math.max(0, items.length-2)));
      };

      const removeItem = (idx) => {
        if(!confirm('刪除這個行程？')) return;
        currentDay.value.items.splice(idx,1);
        nextTick(()=> recalcFrom(Math.max(0, idx-1)));
      };

      const toggleLock = (idx) => {
        const it = currentDay.value.items[idx];
        it.locked = !it.locked;
        showToast(it.locked ? '已鎖定此時間' : '已解除鎖定');
        nextTick(()=> recalcFrom(idx));
      };

      // ---------- wheel open ----------
      const openWheel = (mode, idx) => {
        wheel.mode = mode;
        wheel.targetIdx = idx;
        const it = currentDay.value.items[idx];

        if(mode === 'time'){
          const [h,m] = (it.time || '09:00').split(':');
          wheel.h = h; wheel.m = m;
        }
        if(mode === 'stay'){
          const mins = Number(it.stayMins || 0);
          wheel.h = pad2(Math.floor(mins/60));
          wheel.m = pad2(mins%60);
        }
        if(mode === 'transport'){
          const mins = Number(it.transport?.mins || 0);
          wheel.h = pad2(Math.floor(mins/60));
          wheel.m = pad2(mins%60);
        }

        wheel.show = true;
      };

      const closeWheel = () => wheel.show = false;

      const saveWheel = () => {
        const idx = wheel.targetIdx;
        if(idx === null || idx === undefined) return closeWheel();
        const it = currentDay.value.items[idx];

        if(wheel.mode === 'time'){
          it.time = `${wheel.h}:${wheel.m}`;
          // sort by time, but keep stable order by id when same time
          currentDay.value.items.sort((a,b)=> (a.time.localeCompare(b.time)) || (a.id.localeCompare(b.id)));
          nextTick(()=> recalcFrom(0));
        }
        if(wheel.mode === 'stay'){
          it.stayMins = (parseInt(wheel.h,10)*60 + parseInt(wheel.m,10));
          nextTick(()=> recalcFrom(idx));
        }
        if(wheel.mode === 'transport'){
          if(!it.transport) it.transport = {mode:'walk', mins:0, routeMins:{walk:null,drive:null,transit:null}, lastKey:''};
          it.transport.mins = (parseInt(wheel.h,10)*60 + parseInt(wheel.m,10));
          nextTick(()=> recalcFrom(idx));
        }

        closeWheel();
      };

      // ---------- geocoding (no key) ----------
      const geocode = async (idx) => {
        const it = currentDay.value.items[idx];
        const q = (it.location || '').trim();
        if(!q) return showToast('請先輸入地點');

        try{
          showToast('定位中...');
          const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&q=${encodeURIComponent(q)}`;
          const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
          const data = await res.json();
          if(!data || !data[0]) return showToast('找不到結果，換個關鍵字試試');

          it.lat = Number(data[0].lat);
          it.lon = Number(data[0].lon);
          it.resolved = data[0].display_name || '';
          showToast('已定位完成');
        } catch(e){
          showToast('定位失敗（可能被限流）');
        }
      };

      // ---------- routes (no key) ----------
      const routeKey = (a,b) => `${a.lat},${a.lon}|${b.lat},${b.lon}`;
      const calcRoutes = async (idx) => {
        const items = currentDay.value.items;
        if(idx < 0 || idx >= items.length-1) return;

        const a = items[idx];
        const b = items[idx+1];
        if(a.lat==null || a.lon==null || b.lat==null || b.lon==null) {
          return showToast('前後兩個行程都要先定位');
        }

        const key = routeKey(a,b);
        if(a.transport?.lastKey === key && a.transport?.routeMins?.walk != null){
          showToast('已更新路線');
          return;
        }

        try{
          showToast('計算路線中...');
          const lonlatA = `${a.lon},${a.lat}`;
          const lonlatB = `${b.lon},${b.lat}`;

          // walking
          const w = await fetch(`https://router.project-osrm.org/route/v1/foot/${lonlatA};${lonlatB}?overview=false`);
          const wj = await w.json();
          const walkM = wj?.routes?.[0]?.duration ? Math.max(1, Math.round(wj.routes[0].duration/60)) : null;

          // driving
          const d = await fetch(`https://router.project-osrm.org/route/v1/driving/${lonlatA};${lonlatB}?overview=false`);
          const dj = await d.json();
          const driveM = dj?.routes?.[0]?.duration ? Math.max(1, Math.round(dj.routes[0].duration/60)) : null;

          // transit = estimate (no key). label as estimate.
          const transitM = (driveM != null) ? Math.max(1, Math.round(driveM*1.6)) : null;

          if(!a.transport) a.transport = {mode:'walk', mins:0, routeMins:{walk:null,drive:null,transit:null}, lastKey:''};
          a.transport.routeMins = { walk: walkM, drive: driveM, transit: transitM };
          a.transport.lastKey = key;

          // auto apply by mode
          const mode = a.transport.mode || 'walk';
          const chosen = (mode==='walk') ? walkM : (mode==='car') ? driveM : transitM;
          if(chosen != null) a.transport.mins = chosen;

          showToast('路線已更新');
          nextTick(()=> recalcFrom(idx));
        }catch(e){
          showToast('路線計算失敗（可能被限流）');
        }
      };

      const setTransportMode = (idx, mode) => {
        const it = currentDay.value.items[idx];
        if(!it.transport) it.transport = { mode:'walk', mins:20, routeMins:{walk:null,drive:null,transit:null}, lastKey:'' };
        it.transport.mode = mode;

        const r = it.transport.routeMins || {};
        const chosen = (mode==='walk') ? r.walk : (mode==='car') ? r.drive : r.transit;
        if(chosen != null) it.transport.mins = chosen;

        nextTick(()=> recalcFrom(idx));
      };

      const openGoogleMapsRoute = (idx) => {
        const items = currentDay.value.items;
        if(idx<0 || idx>=items.length-1) return;

        const a = items[idx], b = items[idx+1];
        if(a.lat==null || a.lon==null || b.lat==null || b.lon==null) return showToast('先完成定位');

        const url = `https://www.google.com/maps/dir/?api=1&origin=${a.lat},${a.lon}&destination=${b.lat},${b.lon}&travelmode=walking`;
        // iOS popup may block, so use same-tab navigation
        window.location.href = url;
      };

      // ---------- categories ----------
      const setCategory = (idx, catKey) => {
        currentDay.value.items[idx].category = catKey;
      };

      // ---------- flights ----------
      const addFlight = () => {
        const dayIdx = currentDayIdx.value;
        flights.value.push({
          id: uid(),
          departDayIdx: dayIdx,
          arrivalOffset: 0,
          arrivalDayIdx: dayIdx,
          startTime: '12:25',
          startAirport: 'TPE',
          endTime: '14:20',
          endAirport: 'NRT',
          flightNo: 'BR198'
        });
        showToast('已新增航班');
      };

      const removeFlight = (id) => {
        if(!confirm('移除這段航班？')) return;
        flights.value = flights.value.filter(f=>f.id!==id);
      };

      const updateFlightArrival = (f) => {
        const off = Number(f.arrivalOffset || 0);
        f.arrivalDayIdx = Math.min(days.value.length-1, f.departDayIdx + off);
      };

      const flightDurationMins = (f) => {
        const dep = timeToMin(f.startTime);
        const arr = timeToMin(f.endTime);
        let delta = arr - dep;
        if(Number(f.arrivalOffset||0) === 1) delta += 1440;
        if(delta < 0) delta += 1440;
        return delta;
      };

      // ---------- money ----------
      const newExpense = ref({ item:'', amount:'', dayIdx:0 });

      const addExpense = () => {
        const it = (newExpense.value.item||'').trim();
        const amt = Number(newExpense.value.amount);
        if(!it || !amt) return showToast('請輸入項目與金額');
        expenses.value.push({
          id: uid(),
          dayIdx: currentDayIdx.value,
          item: it,
          amount: amt
        });
        newExpense.value = { item:'', amount:'', dayIdx: currentDayIdx.value };
        showToast('已加入支出');
      };

      const removeExpense = (id) => {
        expenses.value = expenses.value.filter(e=>e.id!==id);
      };

      // ---------- exchange rate (daily refresh) ----------
      const fetchExchangeRateIfNeeded = async (force=false) => {
        const today = todayISO();
        if(!force && exchangeMeta.value?.date === today && exchangeRate.value > 0) return;

        try{
          const res = await fetch(FX_URL, { headers:{ 'Accept':'application/json' }});
          const j = await res.json();
          const rates = j?.rates || {};
          const cur = setup.value.currency || 'JPY';

          if(!rates.TWD || !rates[cur]) {
            showToast('匯率來源不支援此幣別');
            return;
          }

          const twdPerCur = rates.TWD / rates[cur];
          exchangeRate.value = Number(twdPerCur.toFixed(6));
          exchangeMeta.value = { date: today, base:'USD' };
          showToast('匯率已更新');
        } catch(e){
          // keep old rate
          if(exchangeRate.value <= 0){
            exchangeRate.value = 0;
          }
          showToast('匯率更新失敗（離線或被限流）');
        }
      };

      watch(()=>setup.value.currency, ()=> fetchExchangeRateIfNeeded(true));

      // ---------- translate ----------
      const swapLang = () => {
        const a = tr.value.sl;
        tr.value.sl = tr.value.tl;
        tr.value.tl = a;
      };

      const openGoogleTranslate = () => {
        const text = (tr.value.text||'').trim();
        if(!text) return showToast('請先輸入文字');
        const url = `https://translate.google.com/?sl=${encodeURIComponent(tr.value.sl)}&tl=${encodeURIComponent(tr.value.tl)}&text=${encodeURIComponent(text)}&op=translate`;
        window.location.href = url;
      };

      const copyChatGPTPrompt = async () => {
        const text = (tr.value.text||'').trim();
        if(!text) return showToast('請先輸入文字');

        const src = langDefs.find(x=>x.code===tr.value.sl)?.name || tr.value.sl;
        const tgt = langDefs.find(x=>x.code===tr.value.tl)?.name || tr.value.tl;

        const prompt =
`請把以下內容從「${src}」翻譯成「${tgt}」：
- 語氣自然、符合當地日常用法
- 如果是點餐/問路請偏禮貌
- 保留原本重點，不要過度改寫

原文：
${text}`;

        try{
          await navigator.clipboard.writeText(prompt);
          showToast('已複製 ChatGPT 翻譯提示詞');
        } catch {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = prompt;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('已複製（fallback）');
        }
      };

      const setPhrase = (t) => {
        tr.value.text = t;
      };

      // ---------- start screen search (destination only, no need fancy) ----------
      const searchQuery = ref('');
      const suggestions = ref([]);
      const isSearching = ref(false);
      let debounceTimer = null;

      const debounceSearch = () => {
        clearTimeout(debounceTimer);
        const q = (searchQuery.value||'').trim();
        if(!q){ suggestions.value=[]; return; }
        isSearching.value = true;

        debounceTimer = setTimeout(async ()=>{
          try{
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=5`);
            const data = await res.json();
            suggestions.value = data || [];
          } catch {
            suggestions.value = [];
          } finally {
            isSearching.value = false;
          }
        }, 450);
      };

      const selectLocation = (item) => {
        const cityName = (item.display_name || '').split(',')[0] || '';
        setup.value.destination = cityName;
        searchQuery.value = cityName;
        suggestions.value = [];
      };

      const clearSearch = () => {
        searchQuery.value='';
        setup.value.destination='';
        suggestions.value=[];
      };

      // ---------- mounted ----------
      onMounted(()=>{
        load();

        // register SW
        if('serviceWorker' in navigator){
          navigator.serviceWorker.register('./sw.js').catch(()=>{});
        }

        // daily refresh check
        fetchExchangeRateIfNeeded(false);
      });

      // ---------- UI helpers ----------
      const catLabel = (k) => catDefs.find(x=>x.k===k)?.t || '景點';
      const catIcon = (k) => catDefs.find(x=>x.k===k)?.icon || 'location_on';

      // ---------- template ----------
      return {
        // state
        hasStarted, setup, viewMode, currentDayIdx, days, currentDay, totalDays,
        flights, flightForDay, addFlight, removeFlight, updateFlightArrival, flightDurationMins,
        expenses, totalExpense, dayExpense, newExpense, addExpense, removeExpense,
        exchangeRate, exchangeMeta, fetchExchangeRateIfNeeded,
        autoPush,

        // start search
        searchQuery, suggestions, isSearching, debounceSearch, selectLocation, clearSearch,
        initTrip, addDay,

        // items
        addItem, removeItem,
        openWheel, closeWheel, saveWheel, wheel,
        toggleLock,
        geocode,
        calcRoutes, setTransportMode, openGoogleMapsRoute,
        setCategory, catDefs, catLabel, catIcon,
        durLabel,

        // translate
        tr, langDefs, swapLang, openGoogleTranslate, copyChatGPTPrompt, setPhrase,

        // toast
        toast, showToast,

        // helpers
        minToTime
      };
    },

    template: `
      <div>
        <div v-if="!hasStarted" class="start">
          <div class="start-card">
            <div class="start-brand">
              <div class="logo"><span class="material-icons">flight_takeoff</span></div>
              <div>
                <div class="b1">Travel Plan</div>
                <div class="b2">Material Design 風格 · PWA</div>
              </div>
            </div>

            <div class="field">
              <div class="label">目的地 DESTINATION</div>
              <div style="position:relative">
                <input v-model="searchQuery" @input="debounceSearch" placeholder="輸入城市 (例如: 大阪, 巴黎, 曼谷...)" />
                <div v-if="isSearching" style="position:absolute; right:12px; top:12px; opacity:.7;">
                  <span class="material-icons">hourglass_top</span>
                </div>
                <button v-else-if="searchQuery" class="icon-mini" style="position:absolute; right:8px; top:8px;" @click="clearSearch">
                  <span class="material-icons">close</span>
                </button>

                <div v-if="suggestions.length" class="md-card" style="position:absolute; left:0; right:0; top:56px; padding:0; overflow:hidden; z-index:20">
                  <div v-for="(s,i) in suggestions" :key="i"
                       @click="selectLocation(s)"
                       style="padding:12px 14px; border-bottom:1px solid var(--md-outline); cursor:pointer">
                    <div style="font-weight:800">{{ (s.display_name||'').split(',')[0] }}</div>
                    <div class="muted" style="font-size:12px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                      {{ s.display_name }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px;">
              <div class="field">
                <div class="label">去程 START</div>
                <input type="date" v-model="setup.startDate"/>
              </div>
              <div class="field">
                <div class="label">回程 END</div>
                <input type="date" v-model="setup.endDate"/>
              </div>
            </div>

            <div class="field" style="margin-top:12px;">
              <div class="label">貨幣 CURRENCY</div>
              <select v-model="setup.currency">
                <option value="TWD">TWD 台幣</option>
                <option value="JPY">JPY 日幣</option>
                <option value="KRW">KRW 韓元</option>
                <option value="USD">USD 美金</option>
                <option value="EUR">EUR 歐元</option>
                <option value="HKD">HKD 港幣</option>
                <option value="THB">THB 泰銖</option>
                <option value="SGD">SGD 新幣</option>
                <option value="AUD">AUD 澳幣</option>
                <option value="NZD">NZD 紐幣</option>
                <option value="GBP">GBP 英鎊</option>
                <option value="CHF">CHF 瑞士法郎</option>
                <option value="CNY">CNY 人民幣</option>
                <option value="VND">VND 越南盾</option>
                <option value="MYR">MYR 馬幣</option>
                <option value="PHP">PHP 披索</option>
                <option value="IDR">IDR 印尼盾</option>
              </select>
            </div>

            <button class="btn btn-primary" style="width:100%; margin-top:14px" @click="initTrip">
              <span class="material-icons">rocket_launch</span>
              建立行程
            </button>

            <div class="muted" style="font-size:12px; margin-top:12px;">
              提示：建立後可「加入主畫面」當 App 使用（PWA）。
            </div>
          </div>
        </div>

        <div v-else class="app">
          <!-- Top bar -->
          <div class="topbar">
            <div class="topbar-row">
              <div class="top-left">
                <button class="icon-btn" @click="hasStarted=false">
                  <span class="material-icons">arrow_back</span>
                </button>
                <div class="title-block">
                  <div class="title">
                    {{ setup.destination }} <span style="opacity:.9; font-weight:800; font-size:12px; margin-left:8px;">{{ totalDays }}天</span>
                  </div>
                  <div class="subtitle">{{ setup.startDate.replace(/-/g,'/') }} - {{ setup.endDate.replace(/-/g,'/') }}</div>
                </div>
              </div>

              <div class="segmented">
                <button class="seg-btn" :class="{active:viewMode==='plan'}" @click="viewMode='plan'">
                  <span class="material-icons">event_note</span>
                </button>
                <button class="seg-btn" :class="{active:viewMode==='translate'}" @click="viewMode='translate'">
                  <span class="material-icons">translate</span>
                </button>
                <button class="seg-btn" :class="{active:viewMode==='money'}" @click="viewMode='money'">
                  <span class="material-icons">payments</span>
                </button>
              </div>
            </div>

            <div class="day-strip">
              <div v-for="(d,idx) in days" :key="d.fullDate"
                   class="day-card" :class="{active: currentDayIdx===idx}"
                   @click="currentDayIdx=idx">
                <div class="day-small">{{ d.shortDate }}</div>
                <div class="day-big">D{{ idx+1 }}</div>
              </div>

              <div class="day-card" style="min-width:56px" @click="addDay">
                <span class="material-icons" style="font-size:22px;">add</span>
              </div>
            </div>
          </div>

          <!-- Content -->
          <div class="content">

            <!-- PLAN -->
            <template v-if="viewMode==='plan'">
              <div class="md-card">
                <div class="hstack" style="align-items:flex-start">
                  <div class="vstack" style="gap:6px">
                    <div style="font-weight:900; font-size:18px">{{ currentDay.date }}</div>
                    <input v-model="currentDay.title" placeholder="輸入當日主題..." />
                  </div>
                  <div class="spacer"></div>
                  <div class="switch" @click="autoPush=!autoPush">
                    <div class="toggle" :class="{on:autoPush}"></div>
                    <small>自動推算</small>
                  </div>
                </div>
              </div>

              <!-- Flights -->
              <div class="md-card">
                <div class="hstack">
                  <div style="font-weight:900">航班</div>
                  <div class="spacer"></div>
                  <button class="btn btn-ghost" @click="addFlight">
                    <span class="material-icons">add</span> 新增航班（轉機/第二段）
                  </button>
                </div>

                <div style="margin-top:12px;">
                  <div v-if="flightForDay(currentDayIdx).dep.length===0 && flightForDay(currentDayIdx).arr.length===0" class="muted" style="font-size:12px">
                    這一天沒有航班。若跨日抵達，請把 arrivalOffset 設為 +1。
                  </div>

                  <div v-for="f in flightForDay(currentDayIdx).dep" :key="f.id" class="flight" style="margin-top:10px;">
                    <h3>起飛（D{{ f.departDayIdx+1 }}）</h3>

                    <div class="flight-grid">
                      <div class="flight-col">
                        <div class="flight-time">
                          <input v-model="f.startTime" type="time" style="all:unset; color:#fff; font:inherit; font-weight:900; font-size:26px; cursor:pointer;">
                        </div>
                        <div class="flight-air">
                          <input v-model="f.startAirport" placeholder="TPE" style="all:unset; color:#fff; font:inherit; font-weight:800; letter-spacing:.9px; cursor:text;">
                        </div>
                      </div>

                      <div class="flight-mid">
                        <div class="plane material-icons">flight</div>
                        <div class="pill">
                          <div class="big">{{ f.flightNo }}</div>
                          <div class="small">飛行時間 {{ durLabel(flightDurationMins(f)) }}</div>
                        </div>
                      </div>

                      <div class="flight-col right">
                        <div class="flight-time">
                          <input v-model="f.endTime" type="time" style="all:unset; color:#fff; font:inherit; font-weight:900; font-size:26px; cursor:pointer;">
                        </div>
                        <div class="flight-air">
                          <input v-model="f.endAirport" placeholder="NRT" style="all:unset; color:#fff; font:inherit; font-weight:800; letter-spacing:.9px; cursor:text;">
                        </div>
                      </div>
                    </div>

                    <div class="flight-actions">
                      <div class="hstack" style="gap:10px; flex-wrap:wrap;">
                        <div class="pill" style="min-width:auto; padding:10px 12px;">
                          <div class="small" style="margin:0; font-size:12px;">抵達日</div>
                          <select v-model="f.arrivalOffset" @change="updateFlightArrival(f)"
                                  style="margin-top:8px; padding:10px 12px; border-radius:14px; border:none; outline:none;">
                            <option :value="0">同日</option>
                            <option :value="1">+1天</option>
                          </select>
                        </div>
                      </div>

                      <button class="mini-btn" @click="removeFlight(f.id)">
                        <span class="material-icons">delete</span> 移除
                      </button>
                    </div>
                  </div>

                  <div v-for="f in flightForDay(currentDayIdx).arr" :key="'arr-'+f.id" class="flight" style="margin-top:10px; opacity:.96">
                    <h3>抵達（D{{ f.arrivalDayIdx+1 }}）</h3>
                    <div class="flight-grid">
                      <div class="flight-col">
                        <div class="flight-time">{{ f.startTime }}</div>
                        <div class="flight-air">{{ f.startAirport }}</div>
                      </div>

                      <div class="flight-mid">
                        <div class="plane material-icons">flight_land</div>
                        <div class="pill">
                          <div class="big">{{ f.flightNo }}</div>
                          <div class="small">飛行時間 {{ durLabel(flightDurationMins(f)) }}</div>
                        </div>
                      </div>

                      <div class="flight-col right">
                        <div class="flight-time">{{ f.endTime }}</div>
                        <div class="flight-air">{{ f.endAirport }}</div>
                      </div>
                    </div>
                    <div class="muted" style="font-size:12px; margin-top:10px; color:rgba(255,255,255,.85);">
                      提示：跨日航班會在 D1 顯示起飛、D2 顯示抵達（可編輯起飛那張卡）。
                    </div>
                  </div>

                </div>
              </div>

              <!-- Items -->
              <div class="md-card">
                <div class="hstack">
                  <div style="font-weight:900">當日行程</div>
                  <div class="spacer"></div>
                  <button class="btn btn-ghost" @click="addItem">
                    <span class="material-icons">add</span> 新增行程
                  </button>
                </div>

                <div style="margin-top:12px;">
                  <div v-if="currentDay.items.length===0" class="muted" style="font-size:12px;">
                    尚無行程，點「新增行程」開始。
                  </div>

                  <div v-for="(it, idx) in currentDay.items" :key="it.id" style="margin-top:12px;">
                    <div class="item">
                      <div class="timebox" @click="openWheel('time', idx)">
                        <div class="t">{{ it.time }}</div>
                        <div class="sub">
                          <span class="material-icons" style="font-size:14px;">schedule</span>
                          修改
                        </div>
                      </div>

                      <div class="item-main">
                        <input class="item-title" v-model="it.activity" placeholder="行程名稱..." />

                        <div class="loc-row">
                          <span class="material-icons">place</span>
                          <input class="loc-input" v-model="it.location" placeholder="地點（輸入店名/景點，按『定位』）" />
                          <span v-if="it.lat!=null" class="badge">已定位</span>
                        </div>

                        <div v-if="it.resolved" class="muted" style="font-size:12px; margin-top:6px; line-height:1.35;">
                          {{ it.resolved }}
                        </div>

                        <div class="meta-row">
                          <div class="lock-pill" :class="{locked:it.locked}" @click="toggleLock(idx)">
                            <span class="material-icons" style="font-size:16px;">{{ it.locked ? 'lock' : 'lock_open' }}</span>
                            {{ it.locked ? '已鎖定' : '未鎖定' }}
                          </div>

                          <div class="mini-field" @click="openWheel('stay', idx)">
                            <span class="material-icons" style="font-size:16px;">hourglass_bottom</span>
                            停留：<strong style="font-family:ui-monospace;">{{ durLabel(it.stayMins||0) }}</strong>
                          </div>

                          <button class="btn btn-ghost" style="padding:10px 12px; border-radius:999px;" @click="geocode(idx)">
                            <span class="material-icons">my_location</span> 定位
                          </button>
                        </div>

                        <!-- Category chips -->
                        <div class="chip-row" style="margin-top:10px;">
                          <div v-for="c in catDefs" :key="c.k"
                               class="chip" :class="{active: it.category===c.k}"
                               @click="setCategory(idx, c.k)">
                            <span class="material-icons">{{ c.icon }}</span> {{ c.t }}
                          </div>
                        </div>
                      </div>

                      <button class="icon-mini danger" @click="removeItem(idx)">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>

                    <!-- Between transport (except last) -->
                    <div v-if="idx < currentDay.items.length-1" class="between">
                      <div class="between-top">
                        <div class="hstack" style="gap:10px; flex-wrap:wrap;">
                          <div class="mini-field" @click="openWheel('transport', idx)">
                            <span class="material-icons" style="font-size:16px;">swap_horiz</span>
                            間隔：<strong style="font-family:ui-monospace;">{{ durLabel(it.transport?.mins||0) }}</strong>
                          </div>

                          <div class="mini-field" @click="calcRoutes(idx)">
                            <span class="material-icons" style="font-size:16px;">route</span>
                            路線（計算）
                          </div>

                          <div class="mini-field" @click="openGoogleMapsRoute(idx)">
                            <span class="material-icons" style="font-size:16px;">map</span>
                            Google Maps
                          </div>
                        </div>

                        <div class="muted" style="font-size:12px;">
                          {{ catLabel(it.category) }} → {{ catLabel(currentDay.items[idx+1].category) }}
                        </div>
                      </div>

                      <div class="route-row">
                        <div class="route-chips">
                          <div class="route-chip" :class="{active:(it.transport?.mode==='walk')}" @click="setTransportMode(idx,'walk')">
                            🚶 步行
                            <span v-if="it.transport?.routeMins?.walk!=null">· <strong>{{ it.transport.routeMins.walk }}m</strong></span>
                          </div>
                          <div class="route-chip" :class="{active:(it.transport?.mode==='car')}" @click="setTransportMode(idx,'car')">
                            🚗 開車
                            <span v-if="it.transport?.routeMins?.drive!=null">· <strong>{{ it.transport.routeMins.drive }}m</strong></span>
                          </div>
                          <div class="route-chip" :class="{active:(it.transport?.mode==='transit')}" @click="setTransportMode(idx,'transit')">
                            🚇 大眾
                            <span v-if="it.transport?.routeMins?.transit!=null">· <strong>{{ it.transport.routeMins.transit }}m</strong></span>
                            <span class="muted" style="margin-left:4px;">(估)</span>
                          </div>
                        </div>
                      </div>

                      <div class="muted" style="font-size:12px; margin-top:10px; line-height:1.35;">
                        提示：開車/步行為 OSRM 免金鑰計算；大眾運輸為估算（免金鑰限制）。
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </template>

            <!-- TRANSLATE -->
            <template v-else-if="viewMode==='translate'">
              <div class="md-card">
                <div class="hstack">
                  <div style="font-weight:900; display:flex; align-items:center; gap:8px;">
                    <span class="material-icons">translate</span>
                    翻譯
                  </div>
                  <div class="spacer"></div>
                  <button class="btn btn-ghost" @click="swapLang">
                    <span class="material-icons">swap_horiz</span> 交換
                  </button>
                </div>

                <div class="grid2" style="margin-top:12px;">
                  <div class="field">
                    <div class="label">來源語言</div>
                    <select v-model="tr.sl">
                      <option v-for="l in langDefs" :key="l.code" :value="l.code">{{ l.name }}</option>
                    </select>
                  </div>
                  <div class="field">
                    <div class="label">目標語言</div>
                    <select v-model="tr.tl">
                      <option v-for="l in langDefs" :key="l.code" :value="l.code">{{ l.name }}</option>
                    </select>
                  </div>
                </div>

                <div class="field" style="margin-top:12px;">
                  <div class="label">輸入文字</div>
                  <textarea v-model="tr.text" placeholder="輸入你要翻譯的句子..."></textarea>
                </div>

                <div class="chip-row" style="margin-top:12px;">
                  <div class="chip" @click="setPhrase('請問這裡怎麼去？')">請問這裡怎麼去？</div>
                  <div class="chip" @click="setPhrase('我要點餐，謝謝。')">我要點餐，謝謝。</div>
                  <div class="chip" @click="setPhrase('可以刷卡嗎？')">可以刷卡嗎？</div>
                  <div class="chip" @click="setPhrase('這個多少錢？')">這個多少錢？</div>
                  <div class="chip" @click="setPhrase('我想要一份不辣。')">我想要一份不辣。</div>
                  <div class="chip" @click="setPhrase('請幫我叫計程車。')">請幫我叫計程車。</div>
                </div>

                <div class="hstack" style="margin-top:14px; gap:10px; flex-wrap:wrap;">
                  <button class="btn btn-primary" style="flex:1; min-width:220px" @click="openGoogleTranslate">
                    <span class="material-icons">open_in_new</span>
                    用 Google 翻譯開啟
                  </button>

                  <button class="btn btn-ghost" style="flex:1; min-width:220px" @click="copyChatGPTPrompt">
                    <span class="material-icons">content_copy</span>
                    複製 ChatGPT 翻譯提示詞
                  </button>
                </div>

                <div class="muted" style="font-size:12px; margin-top:12px; line-height:1.35;">
                  說明：你沒有 ChatGPT 金鑰也沒關係，這裡用「複製提示詞」貼到 ChatGPT（App/網頁）即可拿到更自然的翻譯。
                </div>
              </div>
            </template>

            <!-- MONEY -->
            <template v-else>
              <div class="md-card" style="background:var(--md-primary); color:#fff; border:none; box-shadow:0 16px 30px rgba(15,118,110,.28)">
                <div class="hstack" style="align-items:flex-start">
                  <div>
                    <div style="opacity:.88; font-size:13px;">總支出 Total</div>
                    <div style="font-size:40px; font-weight:900; margin-top:6px;">
                      {{ setup.currency }} {{ totalExpense.toLocaleString() }}
                    </div>
                    <div style="opacity:.92; font-weight:800; margin-top:6px;">
                      ≈ NT$ {{ Math.round(totalExpense * (exchangeRate||0)).toLocaleString() }}
                    </div>
                    <div style="opacity:.8; font-size:12px; margin-top:8px;">
                      匯率：1 {{ setup.currency }} ≈ {{ (exchangeRate||0).toFixed(4) }} TWD（每日刷新）
                    </div>
                  </div>
                  <div class="spacer"></div>
                  <button class="icon-btn" @click="fetchExchangeRateIfNeeded(true)" title="刷新匯率">
                    <span class="material-icons">refresh</span>
                  </button>
                </div>

                <div style="margin-top:14px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.18); border-radius:18px; padding:12px;">
                  <div style="font-weight:900; margin-bottom:8px;">每日支出</div>
                  <div v-for="(d,idx) in days" :key="d.fullDate"
                       style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.14);">
                    <div style="opacity:.9; font-weight:800;">D{{ idx+1 }} · {{ d.shortDate }}</div>
                    <div style="font-weight:900;">{{ setup.currency }} {{ (dayExpense.get(idx)||0).toLocaleString() }}</div>
                  </div>
                  <div class="muted" style="margin-top:10px; color:rgba(255,255,255,.85); font-size:12px;">
                    小提醒：新增支出會自動記在目前選擇的日期（D{{ currentDayIdx+1 }}）。
                  </div>
                </div>
              </div>

              <div class="md-card">
                <div style="font-weight:900">新增支出（D{{ currentDayIdx+1 }}）</div>
                <div class="hstack" style="margin-top:12px; gap:10px;">
                  <input v-model="newExpense.item" placeholder="項目" />
                  <input v-model.number="newExpense.amount" type="number" placeholder="金額" style="width:120px;" />
                </div>
                <button class="btn btn-primary" style="width:100%; margin-top:12px;" @click="addExpense">
                  <span class="material-icons">add</span> 加入
                </button>
              </div>

              <div class="md-card">
                <div style="font-weight:900">支出清單</div>
                <div v-if="expenses.length===0" class="muted" style="font-size:12px; margin-top:10px;">
                  尚無支出記錄。
                </div>

                <div v-for="e in expenses" :key="e.id"
                     style="margin-top:10px; padding:12px; border:1px solid var(--md-outline); border-radius:16px; background:#fff; display:flex; align-items:center; gap:10px;">
                  <div class="badge">D{{ (e.dayIdx||0)+1 }}</div>
                  <div style="flex:1; min-width:0;">
                    <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ e.item }}</div>
                    <div class="muted" style="font-size:12px; margin-top:4px;">{{ setup.currency }} {{ Number(e.amount||0).toLocaleString() }}</div>
                  </div>
                  <button class="icon-mini danger" @click="removeExpense(e.id)">
                    <span class="material-icons">close</span>
                  </button>
                </div>
              </div>
            </template>

          </div>

          <!-- Bottom sheet -->
          <div v-if="wheel.show" class="overlay" @click.self="closeWheel">
            <div class="sheet">
              <div class="sheet-head">
                <div>
                  <div class="sheet-title">
                    {{ wheel.mode==='time' ? '設定時間' : (wheel.mode==='stay' ? '設定停留時間' : '設定間隔時間') }}
                  </div>
                  <div class="muted" style="font-size:12px; margin-top:4px;">
                    {{ wheel.mode==='time' ? '修改後可自動推算後續（未鎖定的行程）' : '修改後會推算下一個時間點' }}
                  </div>
                </div>
                <button class="btn btn-primary" @click="saveWheel">確認</button>
              </div>

              <div class="wheel">
                <select v-model="wheel.h">
                  <option v-for="h in 24" :key="h-1" :value="String(h-1).padStart(2,'0')">
                    {{ String(h-1).padStart(2,'0') }}
                  </option>
                </select>

                <select v-model="wheel.m">
                  <option v-for="m in 60" :key="m-1" :value="String(m-1).padStart(2,'0')">
                    {{ String(m-1).padStart(2,'0') }}
                  </option>
                </select>
              </div>

              <div class="muted" style="font-size:12px; line-height:1.35;">
                小技巧：如果你希望某一個時間點固定不動，請把該行程設為「已鎖定」。
              </div>
            </div>
          </div>

          <div v-if="toast.show" class="toast">{{ toast.text }}</div>
        </div>
      </div>
    `
  }).mount('#app');
</script>
</body>
</html>