<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Travel Plan V12.2.2 (Material UI)</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0F766E" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <!-- Vue + Tailwind (功能不動；UI用自訂Material CSS覆蓋) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons (保留原先 FontAwesome；新增 Material Symbols 做 Material 視覺) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,1,0" />

  <style>
    /* =========================
       Material Design (M3-ish) Theme Tokens
       ========================= */
    :root{
      --md-sys-color-primary: #0F766E;            /* teal-700 */
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-primary-container: #CCFBF1;  /* teal-100 */
      --md-sys-color-on-primary-container: #134E4A;

      --md-sys-color-secondary-container: #E0F2FE; /* sky-100 */
      --md-sys-color-on-secondary-container: #075985;

      --md-sys-color-surface: #FFFFFF;
      --md-sys-color-surface-variant: #F1F5F9;     /* slate-100 */
      --md-sys-color-surface-container: #F8FAFC;   /* slate-50 */
      --md-sys-color-surface-container-high: #EEF2F7;

      --md-sys-color-on-surface: #0F172A;          /* slate-900 */
      --md-sys-color-on-surface-variant: #475569;  /* slate-600 */

      --md-sys-color-outline: #CBD5E1;             /* slate-300 */
      --md-sys-color-outline-variant: #E2E8F0;     /* slate-200 */

      --md-elevation-1: 0 1px 2px rgba(15,23,42,0.08);
      --md-elevation-2: 0 2px 6px rgba(15,23,42,0.12);
      --md-elevation-3: 0 6px 18px rgba(15,23,42,0.14);

      --md-shape-corner-sm: 12px;
      --md-shape-corner-md: 16px;
      --md-shape-corner-lg: 22px;

      --md-motion-fast: 120ms;
      --md-motion-med: 180ms;
    }

    body{
      font-family: Roboto, "Noto Sans TC", system-ui, -apple-system, Segoe UI, sans-serif;
      background: var(--md-sys-color-surface-variant);
      color: var(--md-sys-color-on-surface);
      -webkit-tap-highlight-color: transparent;
    }

    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    /* =========================
       Material Components (lightweight, no JS)
       ========================= */
    .md-top-appbar{
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      box-shadow: var(--md-elevation-2);
    }
    .md-appbar-title{
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .md-icon-btn{
      width: 40px; height: 40px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--md-motion-fast), background var(--md-motion-fast);
    }
    .md-icon-btn:hover{ background: rgba(255,255,255,0.14); }
    .md-icon-btn:active{ transform: scale(0.96); }

    .md-card{
      background: var(--md-sys-color-surface);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: var(--md-shape-corner-lg);
      box-shadow: var(--md-elevation-1);
    }
    .md-card.e2{ box-shadow: var(--md-elevation-2); }
    .md-card.e3{ box-shadow: var(--md-elevation-3); }

    .md-chip{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface-variant);
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 1px 1px rgba(15,23,42,0.04);
      transition: background var(--md-motion-fast), transform var(--md-motion-fast), box-shadow var(--md-motion-fast);
    }
    .md-chip:hover{ background: var(--md-sys-color-surface-container); }
    .md-chip:active{ transform: scale(0.98); }

    .md-chip.active{
      background: var(--md-sys-color-primary-container);
      border-color: rgba(13,148,136,0.25);
      color: var(--md-sys-color-on-primary-container);
      box-shadow: var(--md-elevation-2);
    }

    .md-button{
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      padding: 12px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform var(--md-motion-fast), box-shadow var(--md-motion-fast), background var(--md-motion-fast);
      user-select: none;
    }
    .md-button:active{ transform: scale(0.98); }

    .md-button.filled{
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      box-shadow: var(--md-elevation-2);
    }
    .md-button.filled:hover{ filter: brightness(0.98); box-shadow: var(--md-elevation-3); }

    .md-button.tonal{
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
      border: 1px solid rgba(13,148,136,0.22);
    }
    .md-button.outlined{
      background: transparent;
      color: var(--md-sys-color-primary);
      border: 1px solid rgba(13,148,136,0.35);
    }

    .md-field{
      border-radius: var(--md-shape-corner-md);
      background: var(--md-sys-color-surface-container-high);
      border: 1px solid var(--md-sys-color-outline-variant);
      padding: 10px 12px;
      transition: border var(--md-motion-fast), box-shadow var(--md-motion-fast), background var(--md-motion-fast);
    }
    .md-field:focus-within{
      border-color: rgba(13,148,136,0.55);
      box-shadow: 0 0 0 3px rgba(13,148,136,0.16);
      background: #F6FFFE;
    }
    .md-field label{
      display: block;
      font-size: 10px;
      font-weight: 900;
      color: rgba(71,85,105,0.9);
      letter-spacing: 0.6px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .md-field .row{
      display: flex; align-items: center; gap: 10px;
    }
    .md-field input, .md-field textarea, .md-field select{
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      font-weight: 800;
      color: var(--md-sys-color-on-surface);
      font-size: 14px;
    }
    .md-field textarea{ font-weight: 700; }

    .md-helper{
      font-size: 11px;
      color: rgba(71,85,105,0.86);
      margin-top: 8px;
    }

    /* Day chips */
    .day-chip{
      width: 76px; height: 56px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.28);
      background: rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      transition: transform var(--md-motion-fast), background var(--md-motion-fast), box-shadow var(--md-motion-fast);
      user-select: none;
    }
    .day-chip:hover{ background: rgba(255,255,255,0.18); }
    .day-chip:active{ transform: scale(0.98); }
    .day-chip.active{
      background: #FFFFFF;
      color: var(--md-sys-color-primary);
      border-color: #FFFFFF;
      box-shadow: var(--md-elevation-3);
      transform: scale(1.02);
    }

    /* Bottom Navigation */
    .md-bottom-nav{
      position: absolute;
      left: 0; right: 0; bottom: 0;
      background: var(--md-sys-color-surface);
      border-top: 1px solid var(--md-sys-color-outline-variant);
      box-shadow: 0 -8px 24px rgba(15,23,42,0.10);
      z-index: 30;
      padding: 8px 12px calc(10px + env(safe-area-inset-bottom));
    }
    .md-nav-item{
      flex: 1;
      border-radius: 999px;
      padding: 10px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 900;
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
      transition: background var(--md-motion-fast), transform var(--md-motion-fast);
      user-select: none;
    }
    .md-nav-item .material-symbols-rounded{ font-size: 22px; }
    .md-nav-item.active{
      background: var(--md-sys-color-primary-container);
      color: var(--md-sys-color-on-primary-container);
    }
    .md-nav-item:active{ transform: scale(0.98); }

    /* Bottom sheet (wheel modal) */
    .md-sheet{
      background: var(--md-sys-color-surface);
      border-radius: 28px 28px 0 0;
      box-shadow: 0 -14px 40px rgba(15,23,42,0.22);
      border: 1px solid var(--md-sys-color-outline-variant);
    }
    .md-sheet-handle{
      width: 40px; height: 4px;
      border-radius: 999px;
      background: rgba(148,163,184,0.55);
      margin: 0 auto 10px;
    }

    /* Existing mechanics kept (wheel/route/transit/flight/etc.) */
    .wheel-container { display: flex; justify-content: center; height: 160px; position: relative; background: var(--md-sys-color-surface-container); border-radius: 18px; overflow: hidden; margin: 10px 0; border: 1px solid var(--md-sys-color-outline-variant); }
    .wheel-highlight { position: absolute; top: 50%; left: 0; width: 100%; height: 40px; background: rgba(13,148,136,0.10); border-top: 1px solid rgba(13,148,136,0.22); border-bottom: 1px solid rgba(13,148,136,0.22); transform: translateY(-50%); pointer-events: none; z-index: 10; }
    .wheel-col { flex: 1; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; padding: 60px 0; box-sizing: border-box; scrollbar-width: none; z-index: 5; }
    .wheel-col::-webkit-scrollbar { display: none; }
    .wheel-item { height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #94a3b8; scroll-snap-align: center; transition: 0.2s; }
    .wheel-item.selected { color: var(--md-sys-color-primary); font-weight: 900; font-size: 22px; transform: scale(1.06); }

    .autocomplete-dropdown {
      position: absolute; top: 100%; left: 0; right: 0;
      background: var(--md-sys-color-surface);
      border: 1px solid var(--md-sys-color-outline-variant);
      border-radius: 18px;
      box-shadow: var(--md-elevation-3);
      z-index: 50; max-height: 260px; overflow-y: auto; margin-top: 6px;
    }
    .suggestion-item {
      padding: 12px 16px; cursor: pointer; font-size: 14px; color: var(--md-sys-color-on-surface-variant);
      border-bottom: 1px solid var(--md-sys-color-outline-variant);
      display: flex; flex-direction: column;
    }
    .suggestion-item:hover { background-color: var(--md-sys-color-surface-container); }
    .suggestion-item:last-child { border-bottom: none; }

    .transit-line { position: absolute; left: 24px; top: -24px; bottom: -24px; width: 2px; background: var(--md-sys-color-outline-variant); z-index: 0; }
    .transit-pill { position: relative; z-index: 10; font-size: 11px; transition: 0.2s; cursor: pointer; user-select: none; }

    .flight-pill {
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.24);
      border-radius: 16px;
      backdrop-filter: blur(6px);
    }

    /* Toast */
    .toast {
      position: absolute;
      left: 50%; transform: translateX(-50%);
      bottom: 88px; /* avoid bottom nav */
      background: rgba(15, 23, 42, 0.92);
      color: white;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      z-index: 60;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    /* Animations */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.25s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.25s ease-out; }
    .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

    /* Setup background */
    .setup-bg{
      background: radial-gradient(900px 500px at 20% 10%, rgba(255,255,255,0.18), transparent 60%),
                  linear-gradient(135deg, #0F766E 0%, #0EA5A5 45%, #2563EB 100%);
    }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">
  <div id="app" class="h-full w-full max-w-md mx-auto relative bg-white sm:h-[95vh] sm:rounded-[28px] sm:my-4 sm:shadow-2xl sm:border-4 sm:border-slate-100 overflow-hidden flex flex-col">

    <!-- SETUP -->
    <div v-if="!hasStarted" class="absolute inset-0 z-50 setup-bg flex flex-col items-center justify-center p-6">
      <div class="w-full max-w-md">
        <div class="text-center mb-5">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/16 backdrop-blur-sm border border-white/18 shadow-md">
            <span class="material-symbols-rounded text-white text-3xl">flight</span>
          </div>
          <h1 class="mt-4 text-3xl font-black text-white tracking-wide">Travel Plan</h1>
          <p class="mt-1 text-white/80 text-sm font-bold">Material Design 版（功能不變）</p>
        </div>

        <div class="md-card e3 p-5 space-y-4 relative">
          <div class="relative">
            <div class="md-field">
              <label>Destination</label>
              <div class="row">
                <span class="material-symbols-rounded text-slate-500">pin_drop</span>
                <input v-model="searchQuery" @input="debounceSearch" placeholder="輸入城市 (例如: 大阪, 巴黎, 曼谷...)">
                <span v-if="isSearching" class="material-symbols-rounded text-teal-700 animate-spin" style="font-variation-settings:'FILL' 1;">progress_activity</span>
                <button v-else-if="searchQuery" @click="clearSearch" class="md-icon-btn" style="width:34px;height:34px;">
                  <span class="material-symbols-rounded text-slate-500">close</span>
                </button>
              </div>
            </div>

            <div v-if="suggestions.length > 0" class="autocomplete-dropdown hide-scroll">
              <div v-for="(item, idx) in suggestions" :key="idx" @click="selectLocation(item)" class="suggestion-item">
                <span class="font-black text-slate-900">{{ item.display_name.split(',')[0] }}</span>
                <span class="text-xs text-slate-500 truncate">{{ item.display_name }}</span>
              </div>
            </div>

            <div v-if="detectedCountry" class="md-helper">
              <div class="flex items-center justify-between gap-2 bg-emerald-50 border border-emerald-100 text-emerald-800 px-3 py-2 rounded-[16px] font-bold">
                <div class="flex items-center gap-2">
                  <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">check_circle</span>
                  <span>偵測到：{{ detectedCountry }}</span>
                </div>
                <span class="bg-white px-2 py-1 rounded-full border border-emerald-100 font-black">轉為 {{ setup.currency }}</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="md-field">
              <label>Start</label>
              <div class="row">
                <span class="material-symbols-rounded text-slate-500">event</span>
                <input v-model="setup.startDate" type="date">
              </div>
            </div>
            <div class="md-field">
              <label>End</label>
              <div class="row">
                <span class="material-symbols-rounded text-slate-500">event_available</span>
                <input v-model="setup.endDate" type="date">
              </div>
            </div>
          </div>

          <div class="md-field">
            <label>Currency</label>
            <div class="row">
              <span class="material-symbols-rounded text-slate-500">payments</span>
              <select v-model="setup.currency" id="currencySelect">
                <optgroup label="亞洲 Asia">
                  <option value="TWD">TWD 台幣</option>
                  <option value="JPY">JPY 日幣</option>
                  <option value="KRW">KRW 韓元</option>
                  <option value="CNY">CNY 人民幣</option>
                  <option value="HKD">HKD 港幣</option>
                  <option value="THB">THB 泰銖</option>
                  <option value="SGD">SGD 新幣</option>
                  <option value="VND">VND 越南盾</option>
                  <option value="MYR">MYR 馬幣</option>
                  <option value="PHP">PHP 披索</option>
                  <option value="IDR">IDR 印尼盾</option>
                </optgroup>
                <optgroup label="美洲 Americas">
                  <option value="USD">USD 美金</option>
                  <option value="CAD">CAD 加幣</option>
                </optgroup>
                <optgroup label="歐洲 Europe">
                  <option value="EUR">EUR 歐元</option>
                  <option value="GBP">GBP 英鎊</option>
                  <option value="CHF">CHF 瑞士法郎</option>
                </optgroup>
                <optgroup label="大洋洲 Oceania">
                  <option value="AUD">AUD 澳幣</option>
                  <option value="NZD">NZD 紐幣</option>
                </optgroup>
              </select>
            </div>
            <div class="md-helper flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="material-symbols-rounded text-teal-700">autorenew</span>
                <span class="font-bold">匯率：每日自動刷新（免金鑰）</span>
              </div>
              <span class="font-black">1 {{ setup.currency }} ≈ NT$ {{ exchangeRate ? exchangeRate.toFixed(3) : '—' }}</span>
            </div>
          </div>

          <button @click="initTrip" class="md-button filled w-full">
            <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">rocket_launch</span>
            <span>建立行程</span>
          </button>
        </div>

        <div class="text-center mt-5 text-white/55 text-xs font-bold">
          Powered by OpenStreetMap / OSRM / open.er-api.com / Google Translate / ChatGPT
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <template v-else>
      <!-- TOP APP BAR -->
      <header class="md-top-appbar shrink-0 z-20">
        <div class="px-4 pt-4 pb-3 flex items-center justify-between">
          <div class="flex items-center gap-2 min-w-0">
            <button class="md-icon-btn" @click="hasStarted=false">
              <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <div class="min-w-0">
              <div class="flex items-center gap-2 min-w-0">
                <h1 class="md-appbar-title text-lg truncate">{{ setup.destination }}</h1>
                <span class="text-[11px] font-black bg-white/18 border border-white/18 px-2 py-1 rounded-full text-white/95">{{ totalDays }}天</span>
              </div>
              <p class="text-[11px] text-white/80 font-bold truncate mt-0.5">
                {{ setup.startDate.replace(/-/g, '/') }} - {{ setup.endDate.replace(/-/g, '/') }}
              </p>
            </div>
          </div>

          <button class="md-icon-btn" @click="forceRefreshFx" title="立即更新匯率">
            <span class="material-symbols-rounded">sync</span>
          </button>
        </div>

        <!-- Day Selector (Material chips) -->
        <div class="flex overflow-x-auto hide-scroll px-3 pb-3 gap-2">
          <button v-for="(day, index) in days" :key="index" @click="currentDayIdx = index"
                  class="day-chip shrink-0">
            <span class="text-[11px] font-bold opacity-85">{{ day.shortDate }}</span>
            <span class="text-sm font-black">D{{ index + 1 }}</span>
          </button>

          <button @click="addDay"
                  class="day-chip shrink-0"
                  style="border-style:dashed;">
            <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">add</span>
            <span class="text-[11px] font-black">新增</span>
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="flex-1 overflow-y-auto relative hide-scroll bg-slate-50" style="padding-bottom: 96px;">
        <!-- PLAN -->
        <div v-if="viewMode === 'plan'" class="p-4">
          <div class="md-card p-4 mb-4">
            <div class="text-xl font-black text-slate-900">{{ currentDay.date }}</div>
            <input v-model="currentDay.title" class="mt-2 w-full bg-transparent border-b border-slate-200 focus:outline-none focus:border-teal-600 text-sm font-bold text-slate-600"
                   placeholder="輸入當日主題...">
          </div>

          <!-- Flights (保留功能，只做視覺微調) -->
          <div class="mb-6">
            <div v-if="flightsForDay.length > 0" class="space-y-3">
              <div v-for="card in flightsForDay" :key="card.key"
                   class="relative rounded-[24px] text-white shadow-lg overflow-hidden"
                   style="background: linear-gradient(90deg, #2563EB, #0EA5A5);">
                <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
                <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>

                <div class="p-4 relative z-0">
                  <button @click="removeFlight(card.segId)"
                          class="absolute top-2 right-2 text-white/70 hover:text-white rounded-full p-2 transition hover:bg-white/15">
                    <span class="material-symbols-rounded">delete</span>
                  </button>

                  <div class="flex items-center justify-between">
                    <div class="w-[38%]">
                      <div class="text-[10px] opacity-70 font-black tracking-wider">起飛</div>
                      <input v-if="card.type !== 'arr'"
                             v-model="flightById(card.segId).depTime" type="time"
                             class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-left text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0 mt-1">
                      <div v-else class="text-2xl font-black font-mono mt-1 opacity-60">—</div>

                      <input v-if="card.type !== 'arr'"
                             v-model="flightById(card.segId).depAirport"
                             class="text-sm font-black opacity-90 bg-transparent border-none w-full text-white/90 placeholder-white/50 focus:ring-0 uppercase p-0 mt-1"
                             placeholder="TPE">
                      <div v-else class="text-xs opacity-70 mt-2">From {{ flightById(card.segId).depAirport || '---' }}</div>
                    </div>

                    <div class="w-[24%] flex flex-col items-center justify-center">
                      <span class="material-symbols-rounded text-2xl" style="transform: rotate(90deg);">flight</span>

                      <input v-model="flightById(card.segId).flightNo"
                             class="text-[10px] font-mono tracking-widest opacity-90 bg-transparent border-none text-center w-full text-white placeholder-white/50 focus:ring-0 uppercase p-0 mt-1"
                             placeholder="BR198">

                      <div class="mt-2 px-3 py-2 flight-pill text-center">
                        <div class="text-[10px] opacity-85 font-black">飛行時間</div>
                        <div class="text-sm font-black font-mono">
                          {{ formatDuration(flightDurationMin(card.segId)) }}
                        </div>
                      </div>
                    </div>

                    <div class="w-[38%] text-right">
                      <div class="text-[10px] opacity-70 font-black tracking-wider flex items-center justify-end gap-2">
                        <span>抵達</span>
                        <select v-if="card.type !== 'arr'"
                                v-model.number="flightById(card.segId).arrOffset"
                                class="appearance-none bg-black/22 text-white text-xs font-black rounded-full border border-white/20 py-1 px-3 text-center focus:ring-0 cursor-pointer hover:bg-black/28">
                          <option :value="0" class="text-slate-800">同日</option>
                          <option :value="1" class="text-slate-800">+1日</option>
                          <option :value="2" class="text-slate-800">+2日</option>
                        </select>
                        <span v-else class="text-xs bg-black/18 px-3 py-1 rounded-full border border-white/20 font-black">
                          +{{ flightById(card.segId).arrOffset }}日
                        </span>
                      </div>

                      <input v-if="card.type !== 'dep'"
                             v-model="flightById(card.segId).arrTime" type="time"
                             class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-right text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0 mt-1">
                      <div v-else class="mt-2 text-base font-black bg-black/18 inline-block px-3 py-2 rounded-full border border-white/20">
                        抵達日顯示
                      </div>

                      <input v-if="card.type !== 'dep'"
                             v-model="flightById(card.segId).arrAirport"
                             class="text-sm font-black opacity-90 bg-transparent border-none w-full text-white/90 placeholder-white/50 focus:ring-0 uppercase p-0 mt-1"
                             placeholder="NRT">
                      <div v-else class="text-xs opacity-70 mt-2">To {{ flightById(card.segId).arrAirport || '---' }}</div>
                    </div>
                  </div>
                </div>
              </div>

              <button @click="addFlightSegment" class="md-button tonal w-full">
                <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">add</span>
                <span>新增航班（轉機/第二段也按這個）</span>
              </button>
            </div>

            <button v-else @click="addFlightSegment" class="md-button outlined w-full">
              <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">flight_takeoff</span>
              <span>新增航班（可多段）</span>
            </button>
          </div>

          <!-- Items -->
          <div class="relative pl-2 space-y-0">
            <div v-for="(item, idx) in currentDay.items" :key="item.id" class="relative group">

              <div class="relative z-10 md-card p-3 flex gap-3 mb-2 hover:shadow-md transition"
                   :class="item.conflict ? 'ring-2 ring-rose-200 border-rose-100' : ''">

                <div class="flex flex-col items-center w-20 shrink-0 justify-center rounded-[18px] border border-slate-200"
                     style="background: var(--md-sys-color-surface-container);">
                  <button @click="openWheel('time', item.id)" class="w-full py-2 hover:bg-white/70 transition rounded-t-[18px]">
                    <div class="text-xl font-black text-slate-900 font-mono leading-none">{{ item.time || '--:--' }}</div>
                    <div class="text-[10px] text-slate-500 mt-1 font-bold">修改</div>
                  </button>
                  <button @click="toggleLock(item)" class="w-full py-2 border-t border-slate-200 flex items-center justify-center gap-2 text-[11px] font-black rounded-b-[18px]"
                          :class="item.locked ? 'text-teal-700 bg-teal-50' : 'text-slate-500 bg-white'">
                    <i class="fa-solid" :class="item.locked ? 'fa-lock' : 'fa-lock-open'"></i>
                    <span>{{ item.locked ? '已鎖定' : '未鎖定' }}</span>
                  </button>
                </div>

                <div class="flex-1 min-w-0 flex flex-col justify-center">
                  <div class="flex items-start justify-between gap-2">
                    <input v-model="item.activity"
                           class="font-black text-slate-900 bg-transparent border-none p-0 focus:ring-0 w-full placeholder-slate-300"
                           placeholder="行程名稱...">

                    <button @click="openWheel('cat', item.id)" class="md-chip shrink-0"
                            :class="item.category ? 'active' : ''"
                            style="padding: 8px 10px;">
                      <i class="fa-solid" :class="getCatIcon(item.category)"></i>
                      <span>{{ item.category }}</span>
                      <span class="material-symbols-rounded" style="font-size:18px;">arrow_drop_down</span>
                    </button>
                  </div>

                  <div class="flex items-center gap-2 mt-2">
                    <span class="material-symbols-rounded text-teal-700" style="font-size:18px;">location_on</span>
                    <input v-model="item.location" @blur="tryGeocode(item)"
                           class="flex-1 text-xs text-slate-600 bg-transparent border-none p-0 focus:ring-0 placeholder-slate-300"
                           placeholder="地點（輸入店名/景點，會自動定位）">

                    <button v-if="!item.lat && item.location"
                            @click="tryGeocode(item)"
                            class="md-button outlined"
                            style="padding: 8px 10px; font-size:11px;">
                      定位
                    </button>
                    <span v-else-if="item.lat"
                          class="md-chip active"
                          style="padding: 8px 10px; font-size:11px;">
                      已定位
                    </span>
                  </div>

                  <div v-if="item.locationAddress" class="text-[10px] text-slate-500 truncate mt-1">
                    {{ item.locationAddress }}
                  </div>

                  <div class="mt-3 flex items-center gap-2 flex-wrap">
                    <button @click="openWheel('stay', item.id)" class="md-chip">
                      <span class="material-symbols-rounded text-slate-600" style="font-size:18px;">schedule</span>
                      <span>停留 · {{ stayLabel(item.stay) }}</span>
                      <span class="material-symbols-rounded" style="font-size:18px;">arrow_drop_down</span>
                    </button>

                    <span v-if="item.conflict" class="md-chip"
                          style="background:#FFF1F2;border-color:#FECDD3;color:#9F1239;">
                      時間衝突 +{{ item.conflictOverMin }}min
                    </span>
                  </div>
                </div>

                <button @click="removeItem(idx)" class="md-icon-btn text-slate-500 hover:text-rose-600" style="width:36px;height:36px;">
                  <span class="material-symbols-rounded">delete</span>
                </button>
              </div>

              <div v-if="idx < currentDay.items.length - 1" class="relative py-3 min-h-[96px] flex items-start pl-6">
                <div class="transit-line"></div>

                <div class="relative z-10 w-full">
                  <div class="flex items-center gap-2">
                    <div @click="openWheel('transit', item.id)"
                         class="md-chip">
                      <i class="fa-solid" :class="getTransIcon(item.transport?.mode)"></i>
                      <span class="font-black font-mono">{{ getTransLabel(item.transport) }}</span>
                      <span class="material-symbols-rounded" style="font-size:18px;">arrow_drop_down</span>
                    </div>

                    <button @click="calcRoute(idx)"
                            :disabled="!canRoute(idx)"
                            class="md-button"
                            :class="canRoute(idx) ? 'tonal' : ''"
                            :style="!canRoute(idx) ? 'background:#EEF2F7;color:#94a3b8;border:1px solid #E2E8F0;' : 'padding:10px 14px;'">
                      <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">route</span>
                      <span>路線</span>
                    </button>
                  </div>

                  <div v-if="item.routeOptions" class="flex flex-wrap gap-2 pl-1 mt-2 pb-1">
                    <div class="md-chip">
                      <span class="material-symbols-rounded">directions_walk</span>
                      <span>步行 {{ item.routeOptions.walkMin }} 分鐘</span>
                    </div>
                    <div class="md-chip">
                      <span class="material-symbols-rounded">directions_car</span>
                      <span>開車 {{ item.routeOptions.driveMin }} 分鐘</span>
                    </div>
                    <a :href="item.routeOptions.gmapsUrl" target="_blank" class="md-chip">
                      <i class="fa-brands fa-google"></i>
                      <span>Google Maps</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button @click="addItem" class="md-button filled w-full mt-4">
            <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">add_circle</span>
            <span>新增行程</span>
          </button>
        </div>

        <!-- TRANSLATE -->
        <div v-if="viewMode === 'translate'" class="p-4">
          <div class="md-card p-4">
            <div class="flex items-center justify-between">
              <div class="text-lg font-black text-slate-900 flex items-center gap-2">
                <span class="material-symbols-rounded text-teal-700" style="font-variation-settings:'FILL' 1;">translate</span>
                <span>翻譯工具</span>
              </div>
              <button @click="swapLang" class="md-button tonal" style="padding:10px 14px;">
                <span class="material-symbols-rounded">swap_horiz</span>
                <span>交換</span>
              </button>
            </div>

            <div class="mt-4">
              <div class="text-[10px] font-black text-slate-500 mb-2 uppercase">來源語言</div>
              <div class="flex flex-wrap gap-2">
                <button v-for="l in langPillsSource" :key="l.code"
                        @click="translator.sl = l.code"
                        class="md-chip"
                        :class="{active: translator.sl === l.code}">
                  <span class="font-black">{{ l.label }}</span>
                  <span class="text-[10px] opacity-70">{{ l.code }}</span>
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="text-[10px] font-black text-slate-500 mb-2 uppercase">目標語言</div>
              <div class="flex flex-wrap gap-2">
                <button v-for="l in langPillsTarget" :key="l.code"
                        @click="translator.tl = l.code"
                        class="md-chip"
                        :class="{active: translator.tl === l.code}">
                  <span class="font-black">{{ l.label }}</span>
                  <span class="text-[10px] opacity-70">{{ l.code }}</span>
                </button>
              </div>
            </div>

            <div class="mt-4">
              <div class="text-[10px] font-black text-slate-500 mb-2 uppercase">ChatGPT 語氣</div>
              <div class="flex flex-wrap gap-2">
                <button v-for="t in tonePills" :key="t.key"
                        @click="translator.tone = t.key"
                        class="md-chip"
                        :class="{active: translator.tone === t.key}">
                  <i class="fa-solid" :class="t.icon"></i>
                  <span>{{ t.label }}</span>
                </button>
              </div>
            </div>

            <div class="mt-4 md-field">
              <label>Text</label>
              <div class="row items-start">
                <span class="material-symbols-rounded text-slate-500" style="margin-top:2px;">edit_note</span>
                <textarea v-model="translator.text" rows="7" placeholder="貼上要翻譯的內容"></textarea>
              </div>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              <button v-for="p in quickPhrases" :key="p"
                      @click="appendPhrase(p)"
                      class="md-chip">
                {{ p }}
              </button>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <button @click="openGoogleTranslate"
                      :disabled="!translator.text.trim()"
                      class="md-button filled w-full"
                      :style="!translator.text.trim() ? 'opacity:.45;pointer-events:none;' : ''">
                <i class="fa-brands fa-google"></i>
                <span>Google 翻譯</span>
              </button>

              <button @click="copyChatGPTPrompt"
                      :disabled="!translator.text.trim()"
                      class="md-button tonal w-full"
                      :style="!translator.text.trim() ? 'opacity:.45;pointer-events:none;' : ''">
                <span class="material-symbols-rounded">content_copy</span>
                <span>複製提示</span>
              </button>
            </div>

            <div class="mt-2 grid grid-cols-2 gap-2">
              <button @click="openChatGPT" class="md-button outlined w-full">
                <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">chat</span>
                <span>開啟 ChatGPT</span>
              </button>

              <button @click="clearTranslate" class="md-button outlined w-full">
                <span class="material-symbols-rounded">clear</span>
                <span>清空</span>
              </button>
            </div>

            <div class="mt-4 md-card p-3" style="background:var(--md-sys-color-surface-container);">
              <div class="flex items-center justify-between">
                <div class="text-[11px] font-black text-slate-600">ChatGPT 提示預覽</div>
                <button @click="copyChatGPTPrompt" class="md-button tonal" style="padding:8px 10px;font-size:11px;">
                  再複製
                </button>
              </div>
              <pre class="mt-2 text-[11px] text-slate-700 whitespace-pre-wrap break-words font-mono">{{ chatgptPrompt }}</pre>
            </div>

            <div class="mt-3 text-[11px] text-slate-500 font-bold">
              免金鑰：先「複製提示」→「開啟 ChatGPT」→ 貼上送出。
            </div>
          </div>
        </div>

        <!-- MONEY -->
        <div v-if="viewMode === 'money'" class="p-4">
          <div class="md-card e3 p-5 mb-6 text-center"
               style="background: linear-gradient(135deg, #0F766E, #0EA5A5); color:white; border:1px solid rgba(255,255,255,0.18);">
            <div class="flex items-start justify-end mb-1">
              <button @click="forceRefreshFx" class="md-chip" style="background:rgba(255,255,255,0.16); border-color:rgba(255,255,255,0.18); color:white;">
                <span class="material-symbols-rounded">sync</span>
                <span>更新匯率</span>
              </button>
            </div>

            <div class="text-sm opacity-85 mb-1 font-bold">總支出 Total</div>
            <div class="text-4xl font-black font-mono">{{ setup.currency }} {{ totalExpense.toLocaleString() }}</div>
            <div class="text-lg font-black mt-2" style="color: rgba(255,255,255,0.88);">
              ≈ NT$ {{ exchangeRate ? Math.round(totalExpense * exchangeRate).toLocaleString() : '—' }}
            </div>
            <div class="text-[11px] mt-2 font-black" style="color: rgba(255,255,255,0.82);">
              1 {{ setup.currency }} ≈ NT$ {{ exchangeRate ? exchangeRate.toFixed(3) : '—' }}
              <span v-if="fx.status==='error'" class="ml-2 px-2 py-0.5 rounded-full" style="background:rgba(244,63,94,0.22); border:1px solid rgba(255,255,255,0.16);">
                匯率抓取失敗
              </span>
            </div>

            <div class="mt-4 md-card p-3 text-left" style="background:rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.18);">
              <div class="flex items-center justify-between mb-2">
                <div class="text-xs font-black" style="color:rgba(255,255,255,0.92);">每日支出</div>
                <div class="text-[10px] font-bold" style="color:rgba(255,255,255,0.74);">點選可跳到該天</div>
              </div>
              <div class="flex gap-2 overflow-x-auto hide-scroll pb-1">
                <button v-for="(amt, idx) in dailyExpenseMap" :key="idx"
                        @click="currentDayIdx = idx"
                        class="md-chip"
                        :class="{active: currentDayIdx===idx}"
                        style="background:rgba(255,255,255,0.12); border-color:rgba(255,255,255,0.18); color:white;">
                  <div class="text-left">
                    <div class="text-[10px] font-black opacity-90">{{ days[idx]?.shortDate || ('D'+(idx+1)) }}</div>
                    <div class="text-sm font-black font-mono">{{ setup.currency }} {{ (amt||0).toLocaleString() }}</div>
                    <div class="text-[10px] font-mono opacity-80">≈ NT$ {{ exchangeRate ? Math.round((amt||0) * exchangeRate).toLocaleString() : '—' }}</div>
                  </div>
                </button>
              </div>
            </div>
          </div>

          <div class="md-card p-4 mb-4">
            <h3 class="text-[11px] font-black text-slate-500 uppercase mb-2">新增支出（記在當天 D{{ currentDayIdx+1 }}）</h3>

            <div class="grid grid-cols-3 gap-2 mb-2">
              <div class="md-field col-span-2">
                <label>Item</label>
                <div class="row">
                  <span class="material-symbols-rounded text-slate-500">receipt_long</span>
                  <input v-model="newExpense.item" placeholder="項目">
                </div>
              </div>
              <div class="md-field">
                <label>Amount</label>
                <div class="row">
                  <span class="material-symbols-rounded text-slate-500">payments</span>
                  <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="font-mono">
                </div>
              </div>
            </div>

            <button @click="addExpense" class="md-button filled w-full">
              <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">add</span>
              <span>加入</span>
            </button>
          </div>

          <div class="space-y-2">
            <div v-for="(exp, i) in expenses" :key="i" class="md-card p-3 flex items-center justify-between">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-9 h-9 rounded-full flex items-center justify-center font-black text-teal-800"
                     style="background:var(--md-sys-color-primary-container); border:1px solid rgba(13,148,136,0.18);">
                  {{ i+1 }}
                </div>
                <div class="min-w-0">
                  <div class="font-black text-slate-900 truncate">{{ exp.item }}</div>
                  <div class="text-[10px] text-slate-500 font-bold">D{{ (exp.dayIdx ?? 0)+1 }} · {{ days[exp.dayIdx]?.shortDate || '' }}</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="font-mono font-black text-slate-700">{{ setup.currency }} {{ exp.amount }}</span>
                <button @click="removeExpense(i)" class="md-icon-btn text-slate-500 hover:text-rose-600" style="width:36px;height:36px;">
                  <span class="material-symbols-rounded">close</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Toast -->
        <transition name="fade">
          <div v-if="toast.show" class="toast">
            <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">check_circle</span>
            <span>{{ toast.text }}</span>
          </div>
        </transition>
      </main>

      <!-- BOTTOM NAV (Material) -->
      <nav class="md-bottom-nav">
        <div class="flex gap-2">
          <button class="md-nav-item" :class="{active: viewMode==='plan'}" @click="viewMode='plan'">
            <span class="material-symbols-rounded">calendar_month</span>
            <span>行程</span>
          </button>
          <button class="md-nav-item" :class="{active: viewMode==='translate'}" @click="viewMode='translate'">
            <span class="material-symbols-rounded">translate</span>
            <span>翻譯</span>
          </button>
          <button class="md-nav-item" :class="{active: viewMode==='money'}" @click="viewMode='money'">
            <span class="material-symbols-rounded">payments</span>
            <span>支出</span>
          </button>
        </div>
      </nav>
    </template>

    <!-- WHEEL MODAL -->
    <transition name="fade">
      <div v-if="wheelState.show" class="absolute inset-0 z-50 flex items-end bg-black/40 backdrop-blur-[2px]" @click.self="closeWheel">
        <transition name="slide-up">
          <div v-if="wheelState.show" class="md-sheet w-full p-5 pb-8">
            <div class="md-sheet-handle"></div>

            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-4">
              <div>
                <h3 class="text-lg font-black text-slate-900">
                  {{ wheelState.mode === 'time' ? '設定開始時間'
                    : (wheelState.mode === 'stay' ? '設定停留時間'
                    : (wheelState.mode === 'cat' ? '設定分類' : '設定交通/休息')) }}
                </h3>
                <p class="text-xs text-slate-500 font-bold">滑動/點選</p>
              </div>
              <button @click="saveWheel" class="md-button filled" style="padding:10px 14px;">
                <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 1;">done</span>
                <span>確認</span>
              </button>
            </div>

            <div v-if="wheelState.mode === 'transit'" class="grid grid-cols-4 gap-2 mb-6">
              <button v-for="m in ['car','walk','transit','rest']" :key="m" @click="wheelState.transMode = m"
                      class="md-chip w-full justify-center"
                      :class="{active: wheelState.transMode === m}">
                <i class="fa-solid text-sm" :class="getTransIcon(m)"></i>
                <span>{{ {'car':'開車','walk':'步行','transit':'大眾','rest':'休息'}[m] }}</span>
              </button>
            </div>

            <div v-if="wheelState.mode === 'cat'" class="grid grid-cols-3 gap-2 mb-2">
              <button v-for="c in categories" :key="c"
                      @click="wheelState.tempCat = c"
                      class="md-chip w-full justify-center"
                      :class="{active: wheelState.tempCat === c}">
                <i class="fa-solid" :class="getCatIcon(c)"></i>
                <span>{{ c }}</span>
              </button>
            </div>

            <div v-if="wheelState.mode !== 'cat'" class="wheel-container">
              <div class="wheel-highlight"></div>
              <div class="wheel-col" ref="wheelHour" @scroll="onScroll('hour')">
                <div class="wheel-item" v-for="h in hoursList" :key="h" :class="{selected: wheelState.tempH === h}">{{ h }}</div>
              </div>
              <div class="flex items-center justify-center font-black text-slate-300 pb-1">:</div>
              <div class="wheel-col" ref="wheelMinute" @scroll="onScroll('minute')">
                <div class="wheel-item" v-for="m in minutesList" :key="m" :class="{selected: wheelState.tempM === m}">{{ m }}</div>
              </div>
            </div>

            <div v-if="wheelState.mode === 'stay'" class="text-[11px] text-slate-600 mt-2 font-bold">
              會依序自動推進下一個時間（遇到「鎖定時間」則不改動，並顯示衝突提示）。
            </div>
          </div>
        </transition>
      </div>
    </transition>

  </div>

<script>
/* =========================
   ✅ 功能程式（JS）完全不變
   （以下內容與你上一版一致）
   ========================= */
const { createApp, ref, computed, nextTick, reactive } = Vue;

const countryCurrencyMap = {
  'tw': 'TWD', 'jp': 'JPY', 'kr': 'KRW', 'cn': 'CNY', 'hk': 'HKD', 'th': 'THB', 'vn': 'VND',
  'sg': 'SGD', 'my': 'MYR', 'ph': 'PHP', 'id': 'IDR', 'us': 'USD', 'ca': 'CAD', 'au': 'AUD',
  'nz': 'NZD', 'gb': 'GBP', 'ch': 'CHF',
  'fr': 'EUR', 'de': 'EUR', 'it': 'EUR', 'es': 'EUR', 'pt': 'EUR', 'nl': 'EUR', 'be': 'EUR',
  'at': 'EUR', 'gr': 'EUR', 'fi': 'EUR', 'ie': 'EUR'
};

createApp({
  setup() {
    const hasStarted = ref(false);
    const viewMode = ref('plan');
    const currentDayIdx = ref(0);

    const todayStr = new Date().toISOString().split('T')[0];
    const setup = ref({ destination: '', startDate: todayStr, endDate: todayStr, currency: 'JPY' });

    const days = ref([]);
    const totalDays = ref(0);

    // Toast
    const toast = reactive({ show:false, text:'' });
    const showToast = (text) => {
      toast.text = text;
      toast.show = true;
      setTimeout(() => toast.show = false, 1400);
    };

    // FX (daily cache)
    const fx = reactive({ status: 'idle', cacheDate: '', providerDate: '', ratesFromTWD: null });
    const exchangeRate = computed(() => {
      const cur = setup.value.currency;
      if (!cur) return null;
      if (cur === 'TWD') return 1;
      const rates = fx.ratesFromTWD;
      if (!rates || !rates[cur]) return null;
      const twdToCur = rates[cur]; // 1 TWD = x CUR
      if (!twdToCur) return null;
      return 1 / twdToCur; // 1 CUR = (1/x) TWD
    });

    const ensureFx = async (force=false) => {
      const today = new Date().toISOString().slice(0,10);
      const cacheKey = 'tp_fx_twd_cache_v1';

      try {
        if (!force) {
          const raw = localStorage.getItem(cacheKey);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && parsed.cacheDate === today && parsed.ratesFromTWD) {
              fx.status = 'ok';
              fx.cacheDate = parsed.cacheDate;
              fx.providerDate = parsed.providerDate || '';
              fx.ratesFromTWD = parsed.ratesFromTWD;
              return;
            }
          }
        }

        fx.status = 'loading';
        const res = await fetch('https://open.er-api.com/v6/latest/TWD');
        const data = await res.json();
        if (!data || data.result !== 'success' || !data.rates) throw new Error('FX API failed');

        fx.status = 'ok';
        fx.cacheDate = today;
        fx.providerDate = (data.time_last_update_utc ? data.time_last_update_utc.split(' ')[0] : '') || today;
        fx.ratesFromTWD = data.rates;

        localStorage.setItem(cacheKey, JSON.stringify({
          cacheDate: fx.cacheDate,
          providerDate: fx.providerDate,
          ratesFromTWD: fx.ratesFromTWD
        }));
      } catch (e) {
        console.error('FX fetch failed:', e);
        fx.status = 'error';
      }
    };
    const forceRefreshFx = async () => ensureFx(true);
    ensureFx(false);

    // Search (Nominatim)
    const searchQuery = ref('');
    const suggestions = ref([]);
    const isSearching = ref(false);
    const detectedCountry = ref('');
    let debounceTimer = null;

    const debounceSearch = () => {
      clearTimeout(debounceTimer);
      if (!searchQuery.value) { suggestions.value = []; return; }
      isSearching.value = true;
      debounceTimer = setTimeout(async () => {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery.value)}&addressdetails=1&limit=5`);
          const data = await res.json();
          suggestions.value = data || [];
        } catch (e) {
          console.error("Search failed", e);
        } finally {
          isSearching.value = false;
        }
      }, 600);
    };

    const selectLocation = (item) => {
      const cityName = item.display_name.split(',')[0];
      setup.value.destination = cityName;
      searchQuery.value = cityName;

      const cc = item.address?.country_code;
      const countryName = item.address?.country;

      if (cc && countryCurrencyMap[cc]) {
        setup.value.currency = countryCurrencyMap[cc];
        detectedCountry.value = `${countryName} (${countryCurrencyMap[cc]})`;
        const selectEl = document.getElementById('currencySelect');
        if (selectEl) {
          selectEl.classList.add('ring-4', 'ring-green-200', 'bg-green-50');
          setTimeout(() => selectEl.classList.remove('ring-4', 'ring-green-200', 'bg-green-50'), 900);
        }
      } else {
        detectedCountry.value = '';
      }
      suggestions.value = [];
    };

    const clearSearch = () => {
      searchQuery.value = '';
      setup.value.destination = '';
      suggestions.value = [];
      detectedCountry.value = '';
    };

    const initTrip = async () => {
      if (!setup.value.destination) return alert('請輸入目的地');
      const start = new Date(setup.value.startDate);
      const end = new Date(setup.value.endDate);
      if (end < start) return alert('回程日期不能早於去程日期');

      const diffTime = Math.abs(end - start);
      totalDays.value = Math.ceil(diffTime / (1000*60*60*24)) + 1;

      days.value = [];
      let d = new Date(start);
      const weekDays = ['日','一','二','三','四','五','六'];

      for (let i=0; i<totalDays.value; i++) {
        const mm = d.getMonth()+1;
        const dd = d.getDate();
        days.value.push({
          shortDate: `${mm}/${dd}`,
          date: `${mm}/${dd} (${weekDays[d.getDay()]})`,
          fullDate: d.toISOString().split('T')[0],
          title: '',
          items: []
        });
        d.setDate(d.getDate()+1);
      }

      currentDayIdx.value = 0;
      hasStarted.value = true;
      await ensureFx(false);
    };

    const addDay = () => {
      const lastDay = new Date(days.value[days.value.length-1].fullDate);
      lastDay.setDate(lastDay.getDate()+1);
      const weekDays = ['日','一','二','三','四','五','六'];
      days.value.push({
        shortDate: `${lastDay.getMonth()+1}/${lastDay.getDate()}`,
        date: `${lastDay.getMonth()+1}/${lastDay.getDate()} (${weekDays[lastDay.getDay()]})`,
        fullDate: lastDay.toISOString().split('T')[0],
        title: '',
        items: []
      });
      setup.value.endDate = lastDay.toISOString().split('T')[0];
      totalDays.value++;
      nextTick(() => { currentDayIdx.value = days.value.length-1; });
    };

    // Items + schedule
    const nextItemId = ref(1);
    const makeItem = (time='09:00') => ({
      id: nextItemId.value++,
      time,
      locked: false,
      conflict: false,
      conflictOverMin: 0,
      category: '景點',
      activity: '',
      location: '',
      locationAddress: '',
      lat: null,
      lon: null,
      stay: { h:'01', m:'00' },
      transport: { mode:'walk', h:'00', m:'20' },
      routeOptions: null
    });

    const currentDay = computed(() => days.value[currentDayIdx.value] || { items: [], date:'', title:'' });

    const parseTimeToMin = (t) => {
      if (!t || !/^\d{2}:\d{2}$/.test(t)) return null;
      const [h,m] = t.split(':').map(n => parseInt(n,10));
      return h*60 + m;
    };
    const minToTime = (min) => {
      min = ((min % 1440) + 1440) % 1440;
      const h = String(Math.floor(min/60)).padStart(2,'0');
      const m = String(min%60).padStart(2,'0');
      return `${h}:${m}`;
    };
    const durToMin = (d) => (parseInt(d?.h||'0',10)*60 + parseInt(d?.m||'0',10));
    const stayLabel = (d) => {
      const h = parseInt(d?.h||'0',10);
      const m = parseInt(d?.m||'0',10);
      const hh = h>0 ? `${h}hr ` : '';
      return `${hh}${String(m).padStart(2,'0')}min`;
    };

    const recalcDaySchedule = (day) => {
      if (!day || !day.items) return;
      day.items.forEach(i => { i.conflict=false; i.conflictOverMin=0; });

      for (let i=0; i<day.items.length-1; i++) {
        const cur = day.items[i];
        const next = day.items[i+1];
        const startMin = parseTimeToMin(cur.time);
        if (startMin == null) continue;

        const expectedNextStart = startMin + durToMin(cur.stay) + durToMin(cur.transport);
        if (!next.locked) {
          next.time = minToTime(expectedNextStart);
        } else {
          const lockedMin = parseTimeToMin(next.time);
          if (lockedMin != null && lockedMin < expectedNextStart) {
            next.conflict = true;
            next.conflictOverMin = expectedNextStart - lockedMin;
          }
          if (lockedMin == null) next.time = minToTime(expectedNextStart);
        }
      }
    };

    const addItem = () => {
      const d = currentDay.value;
      if (!d.items.length) d.items.push(makeItem('09:00'));
      else {
        const last = d.items[d.items.length-1];
        const lastMin = parseTimeToMin(last.time) ?? 9*60;
        const nextStart = lastMin + durToMin(last.stay) + durToMin(last.transport);
        d.items.push(makeItem(minToTime(nextStart)));
      }
      recalcDaySchedule(d);
    };

    const removeItem = (idx) => {
      currentDay.value.items.splice(idx,1);
      recalcDaySchedule(currentDay.value);
    };

    const toggleLock = (item) => {
      item.locked = !item.locked;
      recalcDaySchedule(currentDay.value);
    };

    // Categories
    const categories = ['美食','購物','住宿','遊樂','交通','景點'];
    const catStyle = (c) => {
      const map = {
        '美食': 'bg-rose-50 text-rose-700 border-rose-200',
        '購物': 'bg-violet-50 text-violet-700 border-violet-200',
        '住宿': 'bg-amber-50 text-amber-700 border-amber-200',
        '遊樂': 'bg-emerald-50 text-emerald-700 border-emerald-200',
        '交通': 'bg-sky-50 text-sky-700 border-sky-200',
        '景點': 'bg-teal-50 text-teal-700 border-teal-200',
      };
      return map[c] || 'bg-slate-50 text-slate-700 border-slate-200';
    };
    const getCatIcon = (c) => {
      const map = {
        '美食': 'fa-utensils',
        '購物': 'fa-bag-shopping',
        '住宿': 'fa-hotel',
        '遊樂': 'fa-face-laugh-beam',
        '交通': 'fa-route',
        '景點': 'fa-mountain-sun'
      };
      return map[c] || 'fa-tag';
    };

    // Transit
    const getTransIcon = (m) => ({'car':'fa-car','walk':'fa-person-walking','transit':'fa-train-subway','rest':'fa-mug-hot'}[m] || 'fa-car');
    const getTransLabel = (t) => {
      if (!t) return '設定交通';
      const modeMap = {'car':'開車','walk':'步行','transit':'大眾','rest':'休息'};
      const h = parseInt(t.h||'0',10) > 0 ? `${parseInt(t.h||'0',10)}hr ` : '';
      return `${modeMap[t.mode]} · ${h}${String(t.m||'0').padStart(2,'0')}min`;
    };

    // Wheel
    const wheelState = reactive({
      show:false, mode:'time', targetId:null,
      tempH:'10', tempM:'00', transMode:'walk', tempCat:'景點'
    });
    const hoursList = computed(() => {
      const len = wheelState.mode === 'time' ? 24 : 11;
      return Array.from({length: len}, (_,i)=> i.toString().padStart(2,'0'));
    });
    const minutesList = computed(() => Array.from({length:12},(_,i)=> (i*5).toString().padStart(2,'0')));
    const wheelHour = ref(null);
    const wheelMinute = ref(null);

    const scrollToVal = (el, val) => {
      if (!el) return;
      const idx = Array.from(el.children).findIndex(i => i.innerText === val);
      if (idx !== -1) el.scrollTop = idx * 40;
    };
    const onScroll = (type) => {
      const el = type === 'hour' ? wheelHour.value : wheelMinute.value;
      if (!el) return;
      const index = Math.round(el.scrollTop / 40);
      const list = type === 'hour' ? hoursList.value : minutesList.value;
      if (list[index]) {
        if (type === 'hour') wheelState.tempH = list[index];
        else wheelState.tempM = list[index];
      }
    };
    const findItemById = (id) => currentDay.value.items.find(i => i.id === id);

    const openWheel = (mode, itemId) => {
      wheelState.mode = mode;
      wheelState.targetId = itemId;
      wheelState.show = true;

      const item = findItemById(itemId);
      if (!item) return;

      if (mode === 'time') {
        const [h,m] = (item.time || '09:00').split(':');
        wheelState.tempH = h; wheelState.tempM = m;
      } else if (mode === 'stay') {
        wheelState.tempH = item.stay?.h || '01';
        wheelState.tempM = item.stay?.m || '00';
      } else if (mode === 'transit') {
        wheelState.transMode = item.transport?.mode || 'walk';
        wheelState.tempH = item.transport?.h || '00';
        wheelState.tempM = item.transport?.m || '20';
      } else if (mode === 'cat') {
        wheelState.tempCat = item.category || '景點';
      }

      nextTick(() => {
        if (mode !== 'cat') {
          scrollToVal(wheelHour.value, wheelState.tempH);
          scrollToVal(wheelMinute.value, wheelState.tempM);
        }
      });
    };
    const closeWheel = () => wheelState.show = false;

    const saveWheel = () => {
      const item = findItemById(wheelState.targetId);
      if (!item) return closeWheel();

      if (wheelState.mode === 'cat') {
        item.category = wheelState.tempCat;
        closeWheel();
        return;
      }

      if (wheelState.mode === 'time') item.time = `${wheelState.tempH}:${wheelState.tempM}`;
      else if (wheelState.mode === 'stay') item.stay = { h: wheelState.tempH, m: wheelState.tempM };
      else if (wheelState.mode === 'transit') item.transport = { mode: wheelState.transMode, h: wheelState.tempH, m: wheelState.tempM };

      closeWheel();
      recalcDaySchedule(currentDay.value);
    };

    // Geocode (Nominatim)
    const tryGeocode = async (item) => {
      if (!item || !item.location) return;
      try {
        const q = encodeURIComponent(item.location);
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&addressdetails=1&limit=1`);
        const data = await res.json();
        if (data && data[0]) {
          item.lat = parseFloat(data[0].lat);
          item.lon = parseFloat(data[0].lon);
          item.locationAddress = data[0].display_name || '';
          item.routeOptions = null;
        }
      } catch(e) { console.error('Geocode failed', e); }
    };

    // Route (OSRM)
    const canRoute = (idx) => {
      const a = currentDay.value.items[idx];
      const b = currentDay.value.items[idx+1];
      return !!(a && b && a.lat && a.lon && b.lat && b.lon);
    };
    const buildGmapsUrl = (a, b) => {
      const o = `${a.lat},${a.lon}`;
      const d = `${b.lat},${b.lon}`;
      return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(o)}&destination=${encodeURIComponent(d)}&travelmode=driving`;
    };
    const osrmDurationMin = async (profile, a, b) => {
      const url = `https://router.project-osrm.org/route/v1/${profile}/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
      const res = await fetch(url);
      const data = await res.json();
      const sec = data?.routes?.[0]?.duration;
      if (!sec) return null;
      return Math.max(1, Math.round(sec/60));
    };
    const calcRoute = async (idx) => {
      const a = currentDay.value.items[idx];
      const b = currentDay.value.items[idx+1];
      if (!a || !b || !a.lat || !b.lat) return;
      try {
        const [walkMin, driveMin] = await Promise.all([
          osrmDurationMin('foot', a, b),
          osrmDurationMin('driving', a, b)
        ]);
        a.routeOptions = { walkMin: walkMin ?? '—', driveMin: driveMin ?? '—', gmapsUrl: buildGmapsUrl(a,b) };
      } catch (e) { console.error('Route failed', e); }
    };

    // Money
    const expenses = ref([]);
    const newExpense = ref({ item:'', amount:'' });
    const addExpense = () => {
      const amt = Number(newExpense.value.amount);
      if (!newExpense.value.item || !Number.isFinite(amt)) return;
      expenses.value.push({ item:newExpense.value.item, amount:amt, dayIdx: currentDayIdx.value });
      newExpense.value = { item:'', amount:'' };
    };
    const removeExpense = (i) => expenses.value.splice(i,1);
    const totalExpense = computed(() => expenses.value.reduce((sum,e)=> sum + (e.amount||0), 0));
    const dailyExpenseMap = computed(() => {
      const map = Array.from({length: days.value.length}, () => 0);
      for (const e of expenses.value) {
        const idx = Number.isFinite(e.dayIdx) ? e.dayIdx : 0;
        if (map[idx] != null) map[idx] += (e.amount||0);
      }
      return map;
    });

    // Flights
    const nextFlightId = ref(1);
    const flightSegments = ref([]);
    const addFlightSegment = () => {
      flightSegments.value.push({
        id: nextFlightId.value++,
        depDayIdx: currentDayIdx.value,
        depTime: '12:25',
        depAirport: 'TPE',
        arrTime: '14:20',
        arrAirport: 'NRT',
        arrOffset: 0,
        flightNo: 'BR198'
      });
    };
    const removeFlight = (segId) => {
      const idx = flightSegments.value.findIndex(s => s.id === segId);
      if (idx !== -1) flightSegments.value.splice(idx,1);
    };
    const flightById = (segId) => flightSegments.value.find(s => s.id === segId) || {};
    const flightsForDay = computed(() => {
      const di = currentDayIdx.value;
      const cards = [];
      for (const seg of flightSegments.value) {
        const depDay = seg.depDayIdx;
        const arrDay = seg.depDayIdx + (seg.arrOffset || 0);
        if ((seg.arrOffset||0) === 0) {
          if (depDay === di) cards.push({ key:`f-${seg.id}-full`, type:'full', segId: seg.id });
        } else {
          if (depDay === di) cards.push({ key:`f-${seg.id}-dep`, type:'dep', segId: seg.id });
          if (arrDay === di) cards.push({ key:`f-${seg.id}-arr`, type:'arr', segId: seg.id });
        }
      }
      const weight = (t)=> t==='dep'?0:(t==='full'?1:2);
      const tmin = (card)=>{
        const s = flightById(card.segId);
        const v = (card.type==='arr') ? s.arrTime : s.depTime;
        const m = parseTimeToMin(v);
        return (m==null ? 1e9 : m);
      };
      cards.sort((a,b)=>{
        const dw = weight(a.type) - weight(b.type);
        if (dw !== 0) return dw;
        const dt = tmin(a) - tmin(b);
        if (dt !== 0) return dt;
        const ds = (a.segId||0) - (b.segId||0);
        if (ds !== 0) return ds;
        // final deterministic tie-breaker
        return String(a.key).localeCompare(String(b.key));
      });
      return cards;
    });
    const flightDurationMin = (segId) => {
      const s = flightById(segId);
      const dep = parseTimeToMin(s.depTime);
      const arr = parseTimeToMin(s.arrTime);
      if (dep == null || arr == null) return null;
      const off = parseInt(s.arrOffset||0,10);
      let dur = (off*1440) + (arr - dep);
      if (dur < 0) dur += 1440;
      return dur;
    };
    const formatDuration = (min) => {
      if (!Number.isFinite(min) || min == null) return '—';
      const h = Math.floor(min/60);
      const m = min%60;
      return `${h}h ${String(m).padStart(2,'0')}m`;
    };

    // Translate: Google + ChatGPT (no key)
    const translator = reactive({ sl:'auto', tl:'ja', text:'', tone:'natural' });

    const langMeta = [
      { code:'auto', label:'自動' },
      { code:'zh-TW', label:'繁中' },
      { code:'ja', label:'日文' },
      { code:'en', label:'英文' },
      { code:'ko', label:'韓文' },
      { code:'th', label:'泰文' },
      { code:'vi', label:'越南' },
    ];
    const langLabel = (code) => (langMeta.find(x=>x.code===code)?.label || code);

    const langPillsSource = computed(() => [
      { code:'auto', label:'自動' },
      { code:'zh-TW', label:'繁中' },
      { code:'en', label:'英文' },
      { code:'ja', label:'日文' },
      { code:'ko', label:'韓文' },
      { code:'th', label:'泰文' },
    ]);
    const langPillsTarget = computed(() => [
      { code:'zh-TW', label:'繁中' },
      { code:'en', label:'英文' },
      { code:'ja', label:'日文' },
      { code:'ko', label:'韓文' },
      { code:'th', label:'泰文' },
      { code:'vi', label:'越南' },
    ]);

    const tonePills = [
      { key:'natural', label:'自然口語', icon:'fa-comment-dots' },
      { key:'polite', label:'超禮貌', icon:'fa-handshake' },
      { key:'short', label:'超短一句', icon:'fa-bolt' },
      { key:'local', label:'像在地人', icon:'fa-location-dot' },
    ];

    const quickPhrases = [
      '請問這裡怎麼去？',
      '我要點餐，謝謝。',
      '可以刷卡嗎？',
      '這個多少錢？',
      '我想要一份不辣。',
      '請幫我叫計程車。'
    ];

    const googleTranslateUrl = computed(() => {
      const text = translator.text.trim();
      const sl = translator.sl || 'auto';
      const tl = translator.tl || 'zh-TW';
      return `https://translate.google.com/?sl=${encodeURIComponent(sl)}&tl=${encodeURIComponent(tl)}&text=${encodeURIComponent(text)}&op=translate`;
    });

    // iOS WebApp 常擋 window.open：先 open，失敗就同頁跳轉
    const openGoogleTranslate = () => {
      const text = translator.text.trim();
      if (!text) return;
      const url = googleTranslateUrl.value;
      // iOS/PWA 對 window.open 兼容性不一：用 <a> 觸發最穩
      try {
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        window.location.href = url;
      }
    };

    const toneInstruction = (toneKey) => {
      const map = {
        natural: '請用自然、口語、好懂但不浮誇的語氣。',
        polite: '請用非常禮貌、適合對店員/櫃台/陌生人的語氣。',
        short: '請濃縮成一句話、最短但不失禮。',
        local: '請用更像當地人日常會講的說法（自然、簡潔）。'
      };
      return map[toneKey] || map.natural;
    };

    const chatgptPrompt = computed(() => {
      const src = langLabel(translator.sl || 'auto');
      const tgt = langLabel(translator.tl || 'zh-TW');
      const txt = translator.text.trim();
      const tone = toneInstruction(translator.tone);

      return [
        `請把以下內容從「${src}」翻譯成「${tgt}」。`,
        tone,
        `請輸出：`,
        `1) 自然口語版`,
        `2) 超禮貌版`,
        `3) 超短一句版`,
        `最後再提供「中文回譯」讓我確認意思是否正確。`,
        ``,
        `【內容】`,
        txt || '(尚未輸入文字)'
      ].join('\n');
    });

    const copyTextFallback = (text) => {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try {
        document.execCommand('copy');
        document.body.removeChild(ta);
        return true;
      } catch (e) {
        document.body.removeChild(ta);
        return false;
      }
    };

    const copyChatGPTPrompt = async () => {
      const text = chatgptPrompt.value;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          showToast('已複製 ChatGPT 提示詞');
          return;
        }
      } catch (e) {}
      const ok = copyTextFallback(text);
      showToast(ok ? '已複製 ChatGPT 提示詞' : '複製失敗（請長按全選複製）');
    };

    const openChatGPT = () => {
      const url = 'https://chatgpt.com/';
      // iOS/PWA 對 window.open 兼容性不一：用 <a> 觸發最穩
      try {
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (e) {
        window.location.href = url;
      }
    };

    const clearTranslate = () => { translator.text=''; };
    const swapLang = () => {
      const a = translator.sl;
      translator.sl = translator.tl;
      translator.tl = (a === 'auto') ? 'zh-TW' : a;
      showToast('已交換語言');
    };
    const appendPhrase = (p) => {
      translator.text = (translator.text ? (translator.text + '\n') : '') + p;
      showToast('已加入常用句');
    };

    return {
      hasStarted, viewMode, currentDayIdx, setup, days, totalDays, currentDay,
      toast,
      fx, exchangeRate, forceRefreshFx,
      searchQuery, suggestions, isSearching, detectedCountry,
      debounceSearch, selectLocation, clearSearch,
      initTrip, addDay,
      addItem, removeItem, openWheel, closeWheel, saveWheel, onScroll,
      wheelState, hoursList, minutesList, wheelHour, wheelMinute,
      getTransIcon, getTransLabel, toggleLock, stayLabel,
      categories, catStyle, getCatIcon,
      tryGeocode, canRoute, calcRoute,
      expenses, newExpense, addExpense, removeExpense, totalExpense, dailyExpenseMap,
      flightsForDay, addFlightSegment, removeFlight, flightById, flightDurationMin, formatDuration,
      translator, langPillsSource, langPillsTarget, tonePills,
      quickPhrases, appendPhrase, swapLang,
      openGoogleTranslate, openChatGPT,
      copyChatGPTPrompt, clearTranslate,
      chatgptPrompt
    };
  }
}).mount('#app');
</script>

<script>
  // PWA Service Worker (GitHub Pages /travel-plan/)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(() => {});
    });
  }
</script>

</body>
</html>